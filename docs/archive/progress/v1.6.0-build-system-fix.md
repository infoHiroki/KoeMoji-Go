# Windows ビルドシステム修正記録 - v1.6.0

**日付:** 2025-10-21
**ブランチ:** feature/voicemeeter-integration
**コミット:** 9adacd8, a44cc0d
**担当:** Claude Code

---

## 📊 問題の概要

v1.6.0開発中、Windowsビルドスクリプト（`build.bat`）に複数の問題が発生し、ビルドが正常に完了しなくなった。

### 主な症状

1. **ビルドスクリプトが途中で落ちる**
   - ダブルクリックするとウィンドウが即座に閉じる
   - エラーメッセージが確認できない

2. **手動化の後退**
   - DLLコピー、ZIP作成、releases配置が手動ステップになっていた
   - 以前は自動化されていた処理が失われた

3. **ディレクトリの散乱**
   - 古いv1.5.5のビルド成果物が残存
   - 不要な一時ファイル（`nul`）が生成

---

## 🔍 問題の詳細分析

### 問題1: goversioninfo実行時のエラー

**現象:**
```
installed の使い方が誤っています。
```

**原因:**
```batch
# build.bat 153行目（修正前）
echo Make sure you have a C compiler (MinGW-w64 or MSYS2) installed
```

- エラーメッセージ内の`installed`が誤ってWindowsコマンドとして実行された
- 括弧`()`がコマンド区切りと解釈された

**影響:**
- Goビルドは成功（exeは生成される）
- その直後にエラーで異常終了
- パッケージング処理が実行されない

### 問題2: パス指定の問題

**現象:**
```batch
# DLLコピーが失敗
copy /Y "%~dp0*.dll" "%~dp0%DIST_DIR%\" >nul
```

**原因:**
- `%~dp0%DIST_DIR%`が正しく展開されない
- `%~dp0`（スクリプトディレクトリパス）の末尾に`\`が含まれる

**正しい書き方:**
```batch
copy /Y *.dll "%DIST_DIR%\" >nul
```

### 問題3: versioninfo.jsonの古いバージョン

**現象:**
- アイコン埋め込み時のバージョン情報が1.5.4のまま

**影響:**
- Windowsエクスプローラーでexeのプロパティを見ると古いバージョンが表示される
- リリース時の混乱の原因

### 問題4: ビルド成功時のメッセージが見えない

**現象:**
- ビルドが成功してもウィンドウが即座に閉じる
- エラーなのか成功なのか判断できない

**原因:**
- `pause`コマンドが末尾になかった

---

## 🛠️ 実施した修正

### コミット1: `9adacd8` - ビルドスクリプトの自動化復元

#### 変更内容

**1. DLLコピーの自動化**
```batch
# 追加 (156-162行目)
rem Copy required DLLs (same directory)
echo.
echo Copying required DLL files...
copy /Y *.dll "%DIST_DIR%\" >nul
if %errorlevel% neq 0 (
    echo Warning: Failed to copy DLL files
    exit /b 1
)
```

**2. 配布パッケージの自動作成**
```batch
# 追加 (164-193行目)
cd /d "%~dp0%DIST_DIR%"
if not exist "KoeMoji-Go-v%VERSION%" mkdir "KoeMoji-Go-v%VERSION%"
copy "%APP_NAME%.exe" "KoeMoji-Go-v%VERSION%\" >nul
copy "*.dll" "KoeMoji-Go-v%VERSION%\" >nul
copy "%~dp0..\common\assets\config.example.json" "KoeMoji-Go-v%VERSION%\config.json" >nul
copy "%~dp0..\common\assets\README_RELEASE.md" "KoeMoji-Go-v%VERSION%\README.md" >nul

# ZIP作成
powershell -Command "Compress-Archive -Path 'KoeMoji-Go-v%VERSION%' -DestinationPath '%RELEASE_NAME%.zip' -Force"

# releasesディレクトリへ移動
move /Y "%RELEASE_NAME%.zip" "%~dp0..\releases\" >nul

# 一時フォルダ削除
rmdir /s /q "KoeMoji-Go-v%VERSION%"
```

**3. .gitignore更新**
```gitignore
# 追加
nul
build/windows/dist/
build/windows/temp/
build/windows/KoeMoji-Go-v*/
build/macos/dist/
build/macos/KoeMoji-Go-v*/
```

**4. 古いビルド成果物の削除**
```bash
rm -rf build/windows/KoeMoji-Go-v1.5.5-win/
rm -rf build/windows/temp/
rm nul
```

---

### コミット2: `a44cc0d` - goversioninfo問題の解決

#### 変更内容

**1. versioninfo.json更新**
```json
{
    "FixedFileInfo": {
        "FileVersion": {
            "Major": 1,
            "Minor": 6,  // 5 → 6
            "Patch": 0,  // 4 → 0
            "Build": 0
        },
        "ProductVersion": {
            "Major": 1,
            "Minor": 6,
            "Patch": 0,
            "Build": 0
        }
    },
    "StringFileInfo": {
        "ProductVersion": "1.6.0",  // "1.5.4" → "1.6.0"
        "FileVersion": "1.6.0.0"    // "1.5.4.0" → "1.6.0.0"
    }
}
```

**2. goversioninfoをオプショナル化**
```batch
# 修正 (93-132行目)
rem Generate Windows resource file (optional - will continue without icon if fails)
set RESOURCE_GENERATED=0

if exist "%GOPATH_BIN%\goversioninfo.exe" (
    "%GOPATH_BIN%\goversioninfo.exe" -64 -o "%TEMP_DIR%\resource.syso" versioninfo.json
    if %errorlevel% equ 0 (
        set RESOURCE_GENERATED=1
        echo [OK] Resource file generated successfully
    ) else (
        echo [WARNING] goversioninfo failed - continuing without icon
    )
)

# アイコンが生成された場合のみコピー
if %RESOURCE_GENERATED% equ 1 (
    echo [OK] Icon will be embedded in executable
) else (
    echo [INFO] Building without embedded icon
)
```

**効果:**
- goversioninfoが失敗してもビルドを続行
- アイコンなしのビルドも許容（機能には影響なし）

**3. エラーメッセージの修正**
```batch
# 修正前 (151-154行目)
if %BUILD_ERROR% neq 0 (
    echo Error: Build failed
    echo Make sure you have a C compiler (MinGW-w64 or MSYS2) installed
    exit /b 1
)

# 修正後
if %BUILD_ERROR% neq 0 (
    echo [ERROR] Build failed
    echo Make sure you have a C compiler ^(MinGW-w64 or MSYS2^) available
    exit /b 1
)
```

**変更点:**
- `installed` → `available` （コマンドエラー回避）
- 括弧を`^`でエスケープ（コマンド区切りと解釈されないように）

**4. pause追加**
```batch
# 追加 (219-220行目)
echo Press any key to close...
pause >nul
```

**効果:**
- ビルド完了メッセージが確認できる
- エラー時も画面が残る

---

## ✅ 修正の検証

### テスト環境

- OS: Windows 11 (10.0.26200.6899)
- Go: 1.25.3 windows/amd64
- MSYS2: MinGW64 GCC 15.2.0
- PortAudio: インストール済み

### テスト手順

#### 1. 環境確認テスト
```cmd
cd C:\dev\KoeMoji-Go\build\windows
check_env.bat
```

**結果:**
```
[OK] version.go found
[OK] Go found
[OK] MSYS2 MinGW64 found
[OK] GCC found
[OK] DLL files found
[OK] config.example.json found
[OK] README_RELEASE.md found
```

#### 2. Goビルドのみテスト
```cmd
test_go_build.bat
```

**結果:**
```
Build exit code: 0
[OK] Build succeeded
Executable created: 24,486,400 bytes
```

#### 3. パッケージングのみテスト
```cmd
test_packaging_only.bat
```

**結果:**
```
[Step 1] [OK] DLL files copied
[Step 2] [OK] Folder created
[Step 3] [OK] All files copied
[Step 4] [OK] ZIP created (11,845,434 bytes)
[Step 5] [OK] Moved to releases
```

#### 4. 完全ビルドテスト
```cmd
build.bat
```

**結果:**
```
========================================
  Building KoeMoji-Go for Windows
  Version: 1.6.0
========================================

[OK] Resource file generated successfully
[OK] Icon will be embedded in executable

Build completed successfully

Copying required DLL files...
DLL files copied.

Creating distribution package...
Creating ZIP package...
Moving ZIP to releases directory...
Cleaning up temporary files...

========================================
  Build completed successfully!
========================================

Distribution file created:
  build\releases\KoeMoji-Go-v1.6.0-win.zip

Press any key to close...
```

### 成果物の確認

```bash
$ ls -lh build/releases/KoeMoji-Go-v1.6.0-win.zip
-rw-r--r-- 1 infoh 197609 12M Oct 21 08:48 KoeMoji-Go-v1.6.0-win.zip

$ unzip -l build/releases/KoeMoji-Go-v1.6.0-win.zip
Archive:  KoeMoji-Go-v1.6.0-win.zip
  Length      Date    Time    Name
---------  ---------- -----   ----
     1234  2025-10-20 14:37   KoeMoji-Go-v1.6.0\config.json
 24486400  2025-10-21 08:48   KoeMoji-Go-v1.6.0\koemoji-go.exe      ← アイコン埋め込み成功
   150196  2025-10-19 18:28   KoeMoji-Go-v1.6.0\libgcc_s_seh-1.dll
   230660  2025-10-19 18:28   KoeMoji-Go-v1.6.0\libportaudio.dll
    64409  2025-10-19 18:28   KoeMoji-Go-v1.6.0\libwinpthread-1.dll
     2152  2025-10-19 18:28   KoeMoji-Go-v1.6.0\README.md
---------                     -------
 24935051                     6 files
```

**✅ すべて正常**

---

## 📚 学んだ教訓

### 1. Windowsバッチファイルの罠

**括弧のエスケープ:**
```batch
# NG
echo (MinGW-w64 or MSYS2) installed

# OK
echo ^(MinGW-w64 or MSYS2^) available
```

**パス展開の順序:**
```batch
# NG: %~dp0%VAR% - 変数が正しく展開されない
copy "%~dp0*.dll" "%~dp0%DIST_DIR%\"

# OK: カレントディレクトリで直接指定
copy "*.dll" "%DIST_DIR%\"
```

### 2. goversioninfoの扱い

**問題点:**
- goversioninfo失敗時にビルド全体が止まるのは過剰
- アイコンはあれば良いが、なくても機能は動く

**解決策:**
- オプショナル化して失敗時も続行
- 警告メッセージで状態を明示

### 3. デバッグの重要性

**エラーが見えないと原因特定不可:**
- `pause`コマンドは必須
- ログファイルへの出力も有効

**段階的テストの効果:**
- 環境確認 → Goビルド → パッケージング → 完全ビルド
- どこで失敗しているか特定しやすい

### 4. バージョン管理の一貫性

**versioninfo.jsonの更新忘れ:**
- version.go更新時に連動して更新が必要
- チェックリスト化すべき

---

## 🔧 今後の改善案

### 1. バージョン管理の自動化

**現状:**
- version.go と versioninfo.json を別々に更新

**改善案:**
```batch
rem version.goから動的にバージョン情報を生成
powershell -Command "
$version = (Select-String -Path '..\..\version.go' -Pattern 'const Version = \"(.+)\"').Matches.Groups[1].Value
$versionParts = $version.Split('.')
$json = Get-Content '..\common\templates\windows\versioninfo.json' | ConvertFrom-Json
$json.FixedFileInfo.FileVersion.Major = [int]$versionParts[0]
$json.FixedFileInfo.FileVersion.Minor = [int]$versionParts[1]
$json.FixedFileInfo.FileVersion.Patch = [int]$versionParts[2]
# ... (ProductVersionも同様)
$json | ConvertTo-Json -Depth 10 | Set-Content versioninfo_generated.json
"
```

### 2. ビルド前チェックの強化

```batch
rem 必要な環境のチェック
call check_env.bat
if %errorlevel% neq 0 (
    echo [ERROR] Environment check failed
    exit /b 1
)
```

### 3. クリーンビルドオプション

```batch
build.bat clean   # 古いビルド成果物を削除
build.bat         # 通常ビルド
build.bat full    # clean + build
```

### 4. CI/CD対応

**現状の課題:**
- GitHub ActionsではCGOが使えない（#13で確認済み）

**将来の可能性:**
- セルフホストランナーの利用
- Windows Server上でのビルド自動化

---

## 📝 チェックリスト（次回リリース時）

### バージョン更新時

- [ ] `version.go` のバージョン番号更新
- [ ] `build/common/templates/windows/versioninfo.json` のバージョン更新
- [ ] `README.md` のバージョン更新
- [ ] CHANGELOG（今後作成予定）の更新

### ビルド前

- [ ] `check_env.bat` で環境確認
- [ ] 古いビルド成果物を削除（`build.bat clean`）
- [ ] Gitの状態確認（未コミットの変更がないか）

### ビルド後

- [ ] ZIPファイルが生成されているか
- [ ] ZIP内に6ファイルすべて含まれているか
- [ ] exeファイルサイズが約24MBか
- [ ] Windowsエクスプローラーでexeのプロパティ確認（バージョン情報）
- [ ] アイコンが埋め込まれているか（exe右クリック → プロパティ）

### テスト

- [ ] ビルドしたexeが起動するか
- [ ] 基本機能が動作するか（`test/manual-test-commands.md`参照）

---

## 🔗 関連リソース

### ドキュメント
- [Windows Build Guide](../developer/WINDOWS_BUILD_GUIDE.md)
- [CLAUDE.md](../../CLAUDE.md) - ビルドコマンド
- [Manual Test Commands](../../test/manual-test-commands.md)

### コミット
- `9adacd8` - Windowsビルドスクリプトの自動化を復元
- `a44cc0d` - goversioninfo問題を修正してアイコン付きビルドを実現

### Issues
- （該当なし - 内部開発で発見・解決）

---

**最終更新:** 2025-10-21
**ステータス:** ✅ 解決済み・文書化完了
