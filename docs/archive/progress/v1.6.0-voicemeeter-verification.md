# VoiceMeeter Banana 統合機能検証記録 - v1.6.0

**日付:** 2025-10-21
**ブランチ:** feature/voicemeeter-integration
**担当:** Claude Code + hirokitakamura
**ステータス:** ✅ 検証完了・動作確認済み

---

## 📊 検証概要

v1.6.0で実装されたVoiceMeeter統合機能を、実際のWindows環境（VoiceMeeter Banana）で検証しました。

### 検証目的
- システム音声（YouTube等）とマイクの同時録音が正しく動作するか
- VoiceMeeter Bananaの設定手順が明確か
- 音量自動調整機能が正しく動作するか

### 検証環境
- **OS**: Windows 11 (10.0.26200.6899)
- **VoiceMeeter**: VoiceMeeter Banana（Advanced版）
- **KoeMoji-Go**: v1.6.0（開発版）
- **マイク**: デジタルマイク内蔵インテル® スマート・サウンド・テクノロジー

---

## 🎯 VoiceMeeter Banana設定手順（検証済み）

### 前提条件

VoiceMeeter BananaはVoiceMeeter Basicの上位版で、以下の違いがあります：

| 機能 | Basic | Banana |
|------|-------|--------|
| Hardware Inputs | 2 | 3 |
| Virtual Inputs | 1 | 2 |
| 出力バス | A1 | A1, A2, A3 |
| 仮想出力 | B1 | B1, B2 |

今回の検証ではBananaを使用しましたが、設定方法はBasicでも同様です。

---

## ✅ 設定手順（動作確認済み）

### ステップ1: Windowsサウンド設定（出力）

**場所**: 設定 → システム → サウンド → 出力

**設定内容**:
```
出力デバイス: Voicemeeter Input (VB-Audio Voicemeeter VAIO)
```

**効果**:
- YouTubeやブラウザなどのシステム音がVoiceMeeterに送られる
- VoiceMeeter Bananaの「VIRTUAL INPUTS」セクションに音声が入力される

---

### ステップ2: Windowsサウンド設定（入力）

**場所**: 設定 → システム → サウンド → 入力

**設定内容**:
```
入力デバイス: Voicemeeter Out B1 (VB-Audio Voicemeeter VAIO)
```

**重要**:
- ❌ **A1を選択しない**（A1はスピーカー出力用）
- ✅ **B1を選択**（B1は録音出力用）

**効果**:
- KoeMoji-GoがB1出力を録音デバイスとして認識
- システム音とマイクがミックスされた音声を録音可能

---

### ステップ3: VoiceMeeter Banana設定

#### 3-1. MASTER SECTION（右側）の設定

**A1（Hardware Out）**:
```
物理スピーカー/ヘッドフォンを選択
例: Speakers (Realtek High Definition Audio)
```

**B1（Virtual Output）**:
```
何も設定しない（自動的にWindowsに"VoiceMeeter Output"として表示される）
```

#### 3-2. VIRTUAL INPUTS（中央）の設定

**Voicemeeter Input（システム音）**:
- 下部のボタン: **A1 = ON（緑）**, **B1 = ON（緑）**
- 効果: システム音がスピーカーから聞こえる + 録音される

**Voicemeeter AUX I**（使用する場合）:
- 下部のボタン: **A1 = ON**, **B1 = ON**

#### 3-3. HARDWARE INPUT 1（左側）の設定

**Stereo Input 1（マイク）**:
- 上部: マイクデバイスを選択（例: マイク配列）
- 下部のボタン: **A1 = OFF（グレー）**, **B1 = ON（緑）**

**重要**:
- ❌ **A1をONにしない**（自分の声がスピーカーから聞こえてハウリングする）
- ✅ **B1のみON**（録音のみに送る）

---

### ステップ4: KoeMoji-Go設定

#### config.json（手動設定の場合）

```json
{
    "recording_device_name": "VoiceMeeter Output",
    "audio_normalization_enabled": true
}
```

#### GUI設定（v1.6.0の自動設定機能）

1. KoeMoji-Goを起動
2. `c`キーで設定画面を開く
3. 「VoiceMeeter設定を適用」ボタンをクリック
4. 自動的に:
   - 録音デバイス: VoiceMeeter Output
   - 音量自動調整: ON

---

## 🧪 検証テスト

### テスト手順

1. **VoiceMeeter Banana起動**
2. **KoeMoji-Go起動**
   ```cmd
   cd C:\dev\KoeMoji-Go
   go run ./cmd/koemoji-go --gui
   ```
3. **録音開始**: `r`キーを押す
4. **音声入力テスト**:
   - YouTubeで音楽を再生
   - マイクに話しかける
5. **録音停止**: 再度`r`キーを押す
6. **ファイル確認**: `input/recording_YYYYMMDD_HHMM.wav`

### テスト結果

✅ **システム音**: YouTubeの音楽が録音された
✅ **マイク音**: 自分の声が録音された
✅ **ミックス**: 両方の音が適切にミックスされている
✅ **スピーカー出力**: システム音のみ聞こえる（マイク音は聞こえない）
✅ **音量自動調整**: 小さい音が自動的に増幅された

---

## 📝 発見された問題と解決策

### 問題1: 自分の声がスピーカーから聞こえる

**症状**:
- マイクに話すと、スピーカーから自分の声が聞こえる
- ハウリングの危険性

**原因**:
- HARDWARE INPUT 1のA1ボタンがONになっていた

**解決策**:
```
HARDWARE INPUT 1（マイク）:
- A1: OFF（グレー） ← これが重要
- B1: ON（緑）
```

### 問題2: 録音デバイスにA1を選択していた

**症状**:
- Windowsの入力デバイスが「Voicemeeter Out A1」になっていた
- 録音できない可能性

**原因**:
- A1はスピーカー出力用で、録音用ではない

**解決策**:
```
入力デバイス: Voicemeeter Out B1 に変更
```

---

## 💡 重要な学び

### VoiceMeeterの理解

**A系（A1, A2, A3）**:
- **用途**: スピーカー/ヘッドフォン出力
- **役割**: モニタリング（音を聞くため）
- **設定**: 物理デバイスを指定

**B系（B1, B2）**:
- **用途**: 仮想出力（録音用）
- **役割**: 録音デバイスとしてWindowsに公開
- **設定**: 何も指定しない（自動）

### ルーティングボタンの意味

各入力チャンネル（Virtual Inputs, Hardware Inputs）の下部にあるボタン：

- **A1ボタン（緑）**: A1（スピーカー）に音を送る → 音が聞こえる
- **B1ボタン（緑）**: B1（仮想出力）に音を送る → 録音できる
- **両方ON**: スピーカーで聞きながら録音

### マイクのモニタリング

**通常の用途**:
- マイクのA1は **OFF**（自分の声を聞かない）
- マイクのB1は **ON**（録音する）

**特殊な用途（配信等）**:
- マイクのA1を **ON** にすると自分の声がスピーカーから聞こえる
- ただしハウリングに注意

---

## 🎨 最終的な設定図

```
┌─────────────────────────────────────────────────────────┐
│                     Windows設定                          │
├─────────────────────────────────────────────────────────┤
│ 出力デバイス: Voicemeeter Input                          │
│ 入力デバイス: Voicemeeter Out B1                         │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│               VoiceMeeter Banana                         │
├─────────────────────────────────────────────────────────┤
│                                                          │
│  [VIRTUAL INPUTS]           [HARDWARE INPUT 1]           │
│   Voicemeeter Input          Stereo Input 1             │
│   (システム音)                (マイク配列)               │
│   A1: ✅ ON                   A1: ❌ OFF                 │
│   B1: ✅ ON                   B1: ✅ ON                  │
│                                                          │
│                      [MASTER SECTION]                    │
│                       A1: Speakers (物理)                │
│                       B1: (自動・仮想)                   │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│                  KoeMoji-Go                              │
├─────────────────────────────────────────────────────────┤
│ 録音デバイス: VoiceMeeter Output                         │
│ 音量自動調整: ON                                         │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│                   録音結果                               │
├─────────────────────────────────────────────────────────┤
│ ✅ システム音（YouTube等）                                │
│ ✅ マイク音                                              │
│ ✅ 両方が適切にミックスされている                         │
└─────────────────────────────────────────────────────────┘
```

---

## 📚 ドキュメント更新が必要な箇所

### 1. docs/user/RECORDING_SETUP.md

**更新内容**:
- VoiceMeeter Banana用の詳細手順を追加
- A1/B1の違いを明確に説明
- マイクのA1をOFFにする理由を追加
- スクリーンショット付きガイドを検討

### 2. docs/user/TROUBLESHOOTING.md

**追加すべき項目**:
- 「自分の声がスピーカーから聞こえる」問題
- 「VoiceMeeter Out A1で録音できない」問題

---

## ✅ 検証結論

### 動作確認完了

- ✅ VoiceMeeter Banana統合機能は正常に動作
- ✅ システム音+マイクの同時録音が可能
- ✅ 音量自動調整機能が正しく動作
- ✅ スピーカーからシステム音のみ出力（マイク音は出力されない）

### 推奨事項

1. **ユーザー向けドキュメント**:
   - RECORDING_SETUP.mdにVoiceMeeter Banana詳細手順を追加
   - A1/B1の違いを図解で説明
   - よくある間違い（マイクのA1をON）を明記

2. **トラブルシューティング**:
   - 「自分の声が聞こえる」問題を追加
   - 「録音デバイスにA1を選択してしまった」問題を追加

3. **今後の改善**:
   - GUIで現在の設定状態を可視化
   - VoiceMeeter検出時にBasic/Bananaを判別して適切なガイド表示
   - 録音前のテスト機能（レベルメーター表示）

---

## 🔗 関連リソース

### ドキュメント
- [RECORDING_SETUP.md](../user/RECORDING_SETUP.md) - 録音セットアップガイド
- [VoiceMeeterIntegration.md](../design/VoiceMeeterIntegration.md) - 設計書
- [BASIC_USAGE.md](../user/BASIC_USAGE.md) - 基本的な使用方法

### 外部リンク
- [VoiceMeeter公式サイト](https://vb-audio.com/Voicemeeter/)
- [VoiceMeeter Bananaマニュアル](https://vb-audio.com/Voicemeeter/banana.htm)

---

**最終更新:** 2025-10-21
**ステータス:** ✅ 検証完了・文書化完了
