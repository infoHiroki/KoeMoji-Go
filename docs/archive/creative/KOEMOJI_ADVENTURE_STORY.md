# 声文字の冒険 〜 KoeMoji-Go システムクロニクル

## プロローグ：デジタル世界の新たな物語

遥か未来のデジタル世界。そこには音声を文字に変換する魔法の王国「KoeMoji-Go」がありました。この王国では、様々なキャラクターたちが協力し合い、人間が話した言葉を美しい文字に変換する壮大な冒険を日々繰り広げていました。

---

## 第一章：冒険の始まり（アプリケーション起動）

### 王宮の門番 - メイン関数

王国の正門には、厳格な門番「**メイン・ガーディアン**」が立っていました。彼の仕事は、訪問者（ユーザー）の身分を確認し、適切な案内をすることでした。

「いらっしゃいませ」メイン・ガーディアンは優雅にお辞儀をしました。「まずは、あなたの身分証明書（コマンドライン引数）を拝見させていただきます」

訪問者は小さなカードを差し出しました。そこには様々な文字が刻まれています：
- `--version`（身分証確認）
- `--help`（案内書要求）
- `--gui`（華やかな宮殿への招待状）
- `--configure`（設定変更の許可証）

「ほほう、GUIモードの招待状をお持ちですね」ガーディアンは微笑みました。「それでは、華やかな宮殿（GUI）へご案内いたします。一方、何もお持ちでなければ、伝統的な文字の宮殿（TUI）へどうぞ」

### 二つの宮殿への分岐

**華やかな宮殿（GUI宮殿）** では、美しい宮女「**フィーネ・プリンセス**」が待っていました。彼女は色とりどりの窓やボタンで装飾された豪華な部屋で、訪問者を迎えます。

一方、**文字の宮殿（TUI宮殿）** では、シンプルで実用的な書記官「**ターミナル・マスター**」が黒い背景に緑の文字で書かれた古い巻物を広げ、訪問者を待っていました。

「どちらの宮殿を選ばれても」メイン・ガーディアンは説明しました。「最終的には同じ魔法の工房（内部パッケージ）で作業が行われます」

### 初期化の儀式

宮殿に入ると、まず「**初期化の魔法使い**」が現れました。

「ようこそ、KoeMoji-Go王国へ」魔法使いは杖を振りました。「まずは必要な準備をいたします」

**第一の儀式：ログの精霊召喚**
```
魔法の言葉：initLogger()
効果：ログファイル「koemoji.log」に記録の精霊を宿らせる
```

ログの精霊は透明な存在で、王国で起こるすべての出来事を12個の水晶玉（循環バッファ）に記録していきます。古い記録は自動的に消え、常に最新の12個の出来事だけが保持されます。

**第二の儀式：設定の書の解読**
```
魔法の言葉：config.LoadConfig()
効果：「config.json」という古い書物から王国のルールを読み取る
```

設定の書には、Whisperモデルの種類、言語設定、魔法の力の配分（CPU使用率）など、王国の運営に必要なすべての情報が記されていました。

**第三の儀式：依存関係の確認**
```
魔法の言葉：whisper.EnsureDependencies()
効果：音声転写の魔法使い「FasterWhisper」が王国にいるか確認
```

もし音声転写の魔法使いがいなければ、自動的に召喚（pip install）されます。

---

## 第二章：三つの守護者（メイン処理ループ）

### 処理の守護者 - プロセッサー・ナイト

TUI宮殿では、三人の偉大な守護者が24時間体制で王国を守っていました。

**第一の守護者：プロセッサー・ナイト**

「私の使命は、音声ファイルの監視と処理です」プロセッサー・ナイトは重厚な鎧を身にまとい、巨大な時計を手に持っていました。

彼の日課は以下の通りでした：

```
朝の巡回（初回スキャン）
→ 定期巡回（タイマー設定）
→ 新しい音声ファイル発見
→ 処理キューに追加
→ 一つずつ丁寧に処理
→ アーカイブ倉庫に保管
```

「一度に複数のファイルを処理すると、魔法の力が分散して品質が下がります」ナイトは説明しました。「だから、私は一つずつ、順番に処理するのです」

### 入力の守護者 - インプット・サムライ

**第二の守護者：インプット・サムライ**

「拙者の役目は、人間殿の意思を読み取ることでござる」サムライは刀を腰に差し、正座して待機していました。

サムライが理解できる人間の言葉：
- `c` - 設定変更の道場へ案内
- `l` - ログの巻物を全て展開
- `s` - 手動で巡回を開始
- `i` - 入力の宝箱を開く
- `o` - 出力の宝箱を開く
- `r` - 録音の術を発動/停止
- `q` - 王国からの退出

「人間殿が何も言わずにエンターを押した時」サムライは微笑みました。「それは『今の状況を見せてくれ』という意味でござる。拙者が瞬時にダッシュボードを更新いたします」

### 信号の守護者 - シグナル・ウィザード

**第三の守護者：シグナル・ウィザード**

「私は外界からの緊急信号を監視しています」ウィザードは青い帽子をかぶり、魔法のクリスタルを見つめていました。「Ctrl+Cやシステム終了の信号を受け取ったら、王国の全員に避難指示を出します」

彼のグレースフルシャットダウンの手順：
1. 全ての守護者に「作業を終了せよ」の指令
2. 10秒間の猶予時間を設定
3. 全員の作業完了を確認
4. 安全に王国の門を閉鎖

---

## 第三章：音声ファイルの大冒険（ファイル処理パイプライン）

### 探索隊長 - スキャナー・エクスプローラー

王国の片隅に、探索隊の本部がありました。隊長の「**スキャナー・エクスプローラー**」は、双眼鏡を持ち、定期的に入力の森（inputディレクトリ）を探索していました。

「今日も新しい音声ファイルの冒険者を探しに行くぞ！」エクスプローラーは元気よく森へ向かいました。

**探索の手順：**
```
1. 森の全域をスキャン（filepath.Glob）
2. 音声ファイルの冒険者を発見
3. 既に王国に登録済みかチェック
4. 新しい冒険者だけを選別
5. 処理待ちの宿屋（キュー）に案内
```

「MP3、WAV、M4A、FLAC...様々な出身地の冒険者がいますね」エクスプローラーは記録をつけながら言いました。「みんな、文字に変換されたいという夢を持っているのです」

### 宿屋の女将 - キュー・マネージャー

処理待ちの宿屋では、優しい女将「**キュー・マネージャー**」が冒険者たちの順番を管理していました。

「お疲れ様です、冒険者さん」女将は新しく到着した音声ファイルに微笑みかけました。「こちらの宿屋では、必ず先着順でサービスいたします。列を乱すことは許されません」

宿屋のルール：
- 先入先出（FIFO）の厳格な順番制
- 一度に一人の冒険者のみ処理
- 処理中は他の冒険者は待機
- 完了したら次の冒険者へ

「なぜ一度に一人だけなのかって？」女将は説明しました。「音声転写の魔法使いは、集中力が必要なのです。複数の冒険者を同時に扱うと、魔法の精度が落ちてしまうんですよ」

### 音声転写の大魔法使い - ウィスパー・マスター

宿屋の奥の工房では、王国最強の魔法使い「**ウィスパー・マスター**」が待っていました。彼は大きな水晶球（Whisperモデル）を使って、音声を文字に変換する究極の魔法を使えます。

「ほほう、今度の冒険者は日本語を話すのですね」マスターは水晶球を覗き込みました。「large-v3モデルの力を借りて、完璧な文字変換を行いましょう」

**魔法の詠唱：**
```bash
whisper-ctranslate2 \
  --model large-v3 \
  --language ja \
  --output_dir ./output \
  --output_format txt \
  --compute_type int8 \
  --verbose True \
  recording_20250622_1310.wav
```

「この魔法は時間がかかります」マスターは説明しました。「30秒ごとに進捗を報告する使い魔を送りますので、お待ちください」

### 進捗報告の使い魔 - プログレス・フェアリー

工房の周りを小さな妖精「**プログレス・フェアリー**」が飛び回っていました。

「処理開始から3分経過しました！」
「まだ頑張っています！」
「もう少しお待ちください！」

妖精は30秒ごとに、現在の処理状況をログの精霊に報告していました。

### 要約の詩人 - サマリー・ポエット

音声転写が完了すると、選択的に登場するのが「**サマリー・ポエット**」でした。彼はLLMの力を借りて、長い文字起こしを美しい要約に変換する詩人です。

「転写は完了しましたが、これは少し長いですね」ポエットは羽根ペンを取り出しました。「私がOpenAIの神託の力を借りて、要点をまとめた詩を作りましょう」

**詩の創作過程：**
```
1. 元の文字起こしファイルを読む
2. OpenAI APIに神託を求める
3. 美しい日本語の要約を作成
4. "*_summary.txt"として保存
```

「重要なポイントを箇条書きにして、全体の概要も含めます」ポエットは丁寧に説明しました。「これで、忙しい人間も素早く内容を理解できるでしょう」

### アーカイブの司書 - アーカイブ・リブラリアン

最後に登場するのは、厳格な司書「**アーカイブ・リブラリアン**」です。彼女は完了した音声ファイルを永久保存の図書館に移動させます。

「処理が完了した音声ファイルは、こちらの特別な図書館で永久保存いたします」司書は白い手袋をはめて、ファイルを丁寧に扱いました。

**保存の手順：**
```
1. 元ファイル名をチェック
2. 同名ファイルがあればタイムスタンプ追加
3. アーカイブディレクトリに移動
4. 処理完了をログに記録
```

「こうして、入力の森は常に新しい冒険者を待つ準備ができているのです」司書は微笑みました。

---

## 第四章：音の記録術（録音機能）

### 音響工学の天才 - レコーダー・エンジニア

王国の技術研究所では、天才エンジニア「**レコーダー・エンジニア**」が最新の録音システムを開発していました。

「音を捉える技術は、王国の生命線です」エンジニアは複雑な機械を調整しながら言いました。「私の開発したシステムは、PortAudioという古代の技術を現代的に改良したものです」

### 音の狩人 - サウンド・ハンター

録音が始まると、「**サウンド・ハンター**」という特殊な戦士が登場しました。彼は見えない音の波を捉える能力を持っています。

「44.1kHz、16ビット、モノラル」ハンターは装備を確認しました。「これが最適な狩猟設定です」

**狩猟の戦術：**
```
1. 音の罠（マイク）を設置
2. リアルタイムで音の波をキャッチ
3. メモリの袋（バッファ）に一時保存
4. 袋が満杯になったら一時倉庫にフラッシュ
5. 2秒ごとに定期的にフラッシュ
```

「なぜこんな複雑なことをするのかって？」ハンターは説明しました。「長時間の録音でも、メモリを効率的に使うためです。全部をメモリに保存していたら、王国の資源が枯渇してしまいます」

### 制限の番人 - リミット・ガーディアン

録音中は、「**リミット・ガーディアン**」が常に監視していました。

「録音時間が設定した制限に近づいています」ガーディアンは警告しました。「ファイルサイズも要注意です」

**監視項目：**
- 最大録音時間（設定可能）
- 最大ファイルサイズ（設定可能）
- メモリ使用量
- ディスク容量

「制限に達したら、自動的に録音を停止します」ガーディアンは厳格に言いました。「王国の安定性を守るのが私の使命です」

### WAVの錬金術師 - ウェーブ・アルケミスト

録音が終了すると、「**ウェーブ・アルケミスト**」が音のデータを美しいWAVファイルに変換しました。

「音のデータを黄金のWAVファイルに変換いたします」錬金術師は神秘的な道具を使いました。

**錬金術の工程：**
```
1. WAVヘッダーの作成（44バイトの魔法の印）
2. 一時ファイルのデータを統合
3. メモリバッファの残りデータを追加
4. 最終的なWAVファイルとして結晶化
5. 入力の森に配置（自動処理待ち）
```

「これで、あなたの声は永遠に保存され、すぐに文字変換の冒険に旅立ちます」錬金術師は誇らしげに言いました。

---

## 第五章：二つの王宮（GUI vs TUI）

### 華やかな宮殿の女王 - フィーネ・クイーン

GUI宮殿では、美しい女王「**フィーネ・クイーン**」が統治していました。彼女の宮殿は色とりどりの宝石（ウィジェット）で装飾され、訪問者は直感的に操作できるようになっていました。

「ようこそ、美しい宮殿へ」女王は優雅に手を振りました。「こちらでは、マウスとキーボードで全ての操作ができます」

**宮殿の構造：**
- **ステータス・ルーム**：現在の状況を美しく表示
- **ログ・ライブラリ**：スクロール可能な記録の間
- **コントロール・チェンバー**：ボタンが並ぶ操作室
- **設定・サロン**：タブ形式の設定変更室

「5秒ごとに宮殿全体が自動的に更新されます」女王は説明しました。「忙しい現代人にとって、これが最も快適な環境でしょう」

### 文字の賢者 - ターミナル・セージ

一方、TUI宮殿では、古い賢者「**ターミナル・セージ**」が黒い背景に緑の文字で書かれた古い巻物を広げていました。

「若い者よ、こちらは伝統的な文字の世界です」賢者は長い白髭を撫でました。「キーボード一つで全ての操作ができる、究極にシンプルな世界です」

**賢者の巻物（TUIダッシュボード）：**
```
╭─ KoeMoji-Go Dashboard ─╮
│ Status: Ready           │
│ Queue: 3 files          │
│ Processing: audio1.wav  │
│ Recording: ●REC 00:45   │
│                         │
│ Recent Logs:            │
│ [INFO] Scan complete    │
│ [PROC] Processing...    │
│ [DONE] Conversion done  │
╰─────────────────────────╯
```

「古い方法ですが」賢者は微笑みました。「軽量で高速、そして確実です。真の玄人はこちらを好みます」

### 共通の工房 - シェアード・ワークショップ

興味深いことに、両方の宮殿の地下には、同じ工房がありました。

「表面的な見た目は違いますが」工房の職人「**シェアード・クラフトマン**」は説明しました。「実際の作業は全て同じ場所で行われています」

**共通の職人たち：**
- **設定の書記官** (`internal/config`)
- **ログの記録係** (`internal/logger`)
- **処理の専門家** (`internal/processor`)
- **転写の魔法使い** (`internal/whisper`)
- **録音の技師** (`internal/recorder`)
- **要約の詩人** (`internal/llm`)

「どちらの宮殿を選んでも、最終的な品質と機能は全く同じです」職人は保証しました。「選択は純粋に好みの問題です」

---

## 第六章：設定の神殿（設定管理）

### 設定の大司教 - コンフィグ・アーキビショップ

王国の中心には、神聖な「**設定の神殿**」がそびえ立っていました。そこを統べるのは、賢明な大司教「**コンフィグ・アーキビショップ**」でした。

「王国の全ての法則は、この神聖な書物『config.json』に記されています」大司教は金色に輝く巻物を広げました。

**神聖な書物の内容：**
```json
{
  "whisper_model": "large-v3",     // 転写の魔法レベル
  "language": "ja",                // 王国の公用語
  "ui_language": "ja",             // 表示言語
  "scan_interval_minutes": 1,      // 巡回間隔
  "max_cpu_percent": 95,           // 魔法力の上限
  "compute_type": "int8",          // 計算の精度
  "use_colors": true,              // 色彩の使用
  "output_format": "txt",          // 出力形式
  "input_dir": "./input",          // 入力の森
  "output_dir": "./output",        // 出力の宝庫
  "archive_dir": "./archive",      // 保管の図書館
  // LLM関連の神聖な設定...
  // 録音関連の技術設定...
}
```

### 設定変更の儀式 - コンフィギュレーション・リチュアル

「設定を変更したい時は、特別な儀式を行います」大司教は厳かに説明しました。

**対話式儀式の手順：**
```
1. 神殿への入場（--configure または 'c'キー）
2. 現在の設定の確認と表示
3. 変更したい項目の選択
4. 新しい値の入力と検証
5. 変更の確認と記録
6. 神聖な書物への書き込み
```

「たとえば、Whisperモデルを変更したい場合」大司教は実演しました：

```
Available Whisper models:
1. tiny (速いが精度低)
2. base (バランス型)
3. small (標準的)
4. medium (高品質)
5. large-v3 (最高品質) ← (現在)

Select model (1-5) or press Enter to keep current: 4
```

「選択されたモデルは即座に設定に反映され、次回の転写から適用されます」

### デフォルトの守護霊 - デフォルト・スピリット

設定が存在しない場合や破損した場合、「**デフォルトの守護霊**」が現れました。

「心配無用です」守護霊は優しく言いました。「私が完璧なデフォルト設定を提供いたします」

**守護霊の贈り物：**
- 最高品質のWhisperモデル (large-v3)
- 日本語対応設定
- 適切なディレクトリ構造
- 安全なCPU使用率制限
- LLM統合の基本設定

「これらの設定は、ほとんどのユーザーにとって最適です」守護霊は保証しました。

---

## 第七章：エラーとの戦い（エラーハンドリング）

### 三段階の防衛軍

王国には、様々な脅威（エラー）から国民を守る三段階の防衛軍が存在していました。

### 第一防衛線：情報収集隊 - インフォ・スカウト

「小さな問題や情報をキャッチするのが我々の仕事です」スカウト隊長は双眼鏡を覗きながら言いました。

**担当する情報：**
- デバッグ情報（debugモード時のみ）
- 処理の進捗状況
- 一般的な状況報告
- ユーザーアクション

「これらの情報は脅威ではありませんが、王国の運営には重要です」スカウトは記録を取りながら説明しました。

### 第二防衛線：問題解決部隊 - エラー・レスキュー

「処理の継続に影響する問題を解決するのが我々の任務です」レスキュー隊長は救急箱を持って待機していました。

**対応する問題：**
- ファイル処理の失敗
- 音声転写のエラー
- LLM API の一時的な問題
- 録音デバイスの問題

「これらの問題は深刻ですが、王国全体を停止させる必要はありません」隊長は説明しました。「適切にログに記録し、可能であれば回復処理を行います」

**回復の例：**
```go
if err := whisper.TranscribeAudio(...); err != nil {
    logger.LogError(..., "Processing failed: %v", err)
    // 次のファイルの処理は継続
    continue
}
```

### 第三防衛線：最終防衛隊 - クリティカル・ガーディアン

「王国の存続に関わる致命的な脅威と戦うのが我々です」ガーディアン将軍は重厚な鎧を身にまとっていました。

**対応する脅威：**
- 設定ファイルの重大な破損
- 必須ディレクトリの作成失敗
- システムリソースの完全枯渇
- 外部依存関係の完全な欠如

「これらの脅威に直面した場合」将軍は厳格に言いました。「王国の安全な停止を選択します」

```go
if err != nil {
    logger.LogError(..., "Critical error: %v", err)
    os.Exit(1)  // 名誉ある退却
}
```

### グレースフルシャットダウンの騎士団 - グレースフル・ナイツ

最も尊敬されているのは、「**グレースフルシャットダウンの騎士団**」でした。

「我々の使命は、王国の終了時に全ての作業を安全に完了させることです」騎士団長は誇らしげに言いました。

**騎士団の手順：**
```go
// 第一段階：全員に終了指示
cancel()  // 全ゴルーチンに『撤退せよ』の号令

// 第二段階：秩序ある撤退の監視
done := make(chan bool, 1)
go func() {
    wg.Wait()  // 全員の無事な撤退を確認
    done <- true
}()

// 第三段階：タイムアウト保護
select {
case <-done:
    // 全員無事に撤退完了
    logger.LogInfo(..., "Shutdown completed successfully")
case <-time.After(10 * time.Second):
    // 緊急避難
    logger.LogInfo(..., "Shutdown timeout, forcing exit")
}
```

「この方法により」騎士団長は説明しました。「データの損失や破損を防ぎ、次回の起動時にも問題が発生しないよう保証しています」

---

## 第八章：魔法の工房（内部パッケージの世界）

### 転写の大魔法使い - ウィスパー・アーキメイジ

王国で最も神秘的な場所の一つが、転写の大魔法使い「**ウィスパー・アーキメイジ**」の工房でした。

「音声を文字に変換する...これは古代から受け継がれる最高位の魔法です」アーキメイジは巨大な水晶球を見つめながら言いました。

**魔法の準備段階：**
```go
// セキュリティの結界
// 入力ディレクトリ外のファイルは処理を拒否
absPath, err := filepath.Abs(inputFile)
inputDir, err := filepath.Abs(config.InputDir)
if !strings.HasPrefix(absPath, inputDir+string(os.PathSeparator)) {
    return fmt.Errorf("禁じられた領域のファイルです: %s", inputFile)
}
```

「安全確認は魔法の基本です」アーキメイジは厳しく言いました。「悪意あるファイルから王国を守らねばなりません」

**魔法の詠唱：**
```bash
whisper-ctranslate2 \
  --model large-v3 \      # 最高位の水晶球
  --language ja \         # 日本語の魔法陣
  --output_dir ./output \ # 成果物の保管庫
  --output_format txt \   # 文字の形式
  --compute_type int8 \   # 魔法力の効率化
  --verbose True \        # 進捗の可視化
  inputFile               # 変換対象の音声
```

### 進捗監視の妖精 - プログレス・フェアリー

魔法の詠唱中は、小さな妖精が30秒ごとに進捗を報告していました。

「まだ魔法をかけています♪ 経過時間: 2分30秒」
「頑張っています♪ もう少しお待ちください」
「複雑な音声なので時間がかかっています♪」

### 音声データの錬金術師 - オーディオ・アルケミスト

録音システムでは、「**オーディオ・アルケミスト**」が音の錬金術を行っていました。

「音というエネルギーを、デジタルの結晶に変換する技術です」錬金術師は複雑な装置を調整していました。

**錬金術の工程：**
```go
// 第一段階：音の捕獲
func (r *Recorder) recordCallback(in []int16) {
    // 音波を数値の配列に変換
    r.samples = append(r.samples, in...)
    
    // メモリ管理の魔法
    if len(r.samples) >= FlushThreshold {
        r.flushToTempFile()  // 一時的な保管庫に移動
    }
}
```

「なぜ一時ファイルを使うのかって？」錬金術師は説明しました。「長時間の録音では、全てをメモリに保持すると王国の資源を使い尽くしてしまうからです。私の技術では、メモリ効率を最大化しています」

**WAV形式への最終変換：**
```go
// WAVヘッダーの作成（44バイトの魔法の印）
header := WAVHeader{
    ChunkID:       [4]byte{'R', 'I', 'F', 'F'},
    Format:        [4]byte{'W', 'A', 'V', 'E'},
    SampleRate:    44100,    // 高音質の証
    BitsPerSample: 16,       // 十分な精度
    NumChannels:   1,        // モノラル（効率重視）
}
```

### LLMの神託 - オラクル・サマライザー

最も神秘的な存在は、「**オラクル・サマライザー**」でした。彼は遠い神殿（OpenAI API）から神託を受け取り、長い文章を美しい要約に変換していました。

「文字起こしが完了しましたね」オラクルは水晶玉を覗き込みました。「では、神託の力を借りて要約を作成いたします」

**神託への問いかけ：**
```go
prompt := strings.Replace(config.SummaryPromptTemplate, "{text}", content, 1)
prompt = strings.Replace(prompt, "{language}", config.SummaryLanguage, 1)

// 神託への祈り
response, err := llm.SummarizeText(config, log, logBuffer, logMutex, debugMode, content)
```

「神託は時として気まぐれです」オラクルは苦笑いしました。「レート制限や一時的なサービス停止もあります。そのため、適切な retry logic（再試行の儀式）を組み込んでいます」

---

## 第九章：ログの記録者たち（ログシステム）

### 記録の神官 - ログ・プリースト

王国の全ての出来事は、「**記録の神官**」によって詳細に記録されていました。

「歴史を正確に記録することは、王国の発展に不可欠です」神官は羽根ペンを手に、厳粛に語りました。

**記録の種類：**
- **INFO**：一般的な情報（緑色の聖印）
- **ERROR**：問題の発生（赤色の警告印）
- **DEBUG**：詳細な調査情報（灰色の調査印）
- **PROC**：処理の開始（黄色の作業印）
- **DONE**：作業の完了（緑色の完了印）

### 循環する記憶の書 - サーキュラー・メモワール

最も興味深いのは、「**循環する記憶の書**」でした。この魔法の書物は、常に最新の12個の出来事のみを記憶していました。

```go
func addToLogBuffer(logBuffer *[]LogEntry, logMutex *sync.RWMutex, level, message string) {
    entry := LogEntry{
        Level:     level,
        Message:   message,
        Timestamp: time.Now(),
    }
    
    *logBuffer = append(*logBuffer, entry)
    if len(*logBuffer) > 12 {
        *logBuffer = (*logBuffer)[1:]  // 古い記憶を消去
    }
}
```

「なぜ12個だけなのかって？」書の管理人は説明しました。「ダッシュボードに表示するには、この数が最も適切なのです。重要な情報は永続的なログファイルに記録されますから、心配はいりません」

### 双子の記録者 - ツイン・レコーダー

面白いことに、全てのログは二箇所に記録されていました。

**第一の記録者：ファイル・アーカイバー**
```go
app.logger = log.New(io.MultiWriter(logFile), "", log.LstdFlags)
```
「私は永続的なファイル『koemoji.log』に全ての出来事を記録します」ファイル・アーカイバーは言いました。「この記録は、後日の調査や問題解決に使用されます」

**第二の記録者：メモリ・キーパー**
```go
addToLogBuffer(logBuffer, logMutex, level, message)
```
「私は記憶の書に最新の情報を保持します」メモリ・キーパーは説明しました。「リアルタイムでダッシュボードに表示するためです」

---

## 第十章：設定変更の神殿（対話式設定）

### 設定変更の導師 - コンフィギュレーション・グル

王国で設定を変更したい時は、特別な神殿で「**設定変更の導師**」に会う必要がありました。

「ようこそ、設定変更の神殿へ」導師は慈悲深い笑顔で迎えました。「こちらでは、王国の全ての設定を対話的に変更できます」

**神殿の入口：**
- TUIモードでは `c` キーを押す
- 起動時に `--configure` フラグを使用
- GUIモードでは設定ボタンをクリック

### 18の選択の間 - 18チョイス・チェンバー

神殿の中央には、18の異なる部屋がありました。

```
=== KoeMoji-Go 設定 ===
1. Whisperモデル: large-v3
2. 認識言語: ja
3. UI言語: ja
4. スキャン間隔: 1 分
5. 最大CPU使用率: 95%
6. 計算タイプ: int8
7. 色を使用: true
8. 出力フォーマット: txt
9. 入力ディレクトリ: ./input
10. 出力ディレクトリ: ./output
11. アーカイブディレクトリ: ./archive
12. LLM要約機能: false
13. LLM APIプロバイダー: openai
14. LLM APIキー: [未設定]
15. LLMモデル: gpt-4o
16. 最大トークン数: 4096
17. 要約プロンプト: [編集可能]
18. 録音デバイス名: 既定のマイク
```

### 専門の案内人たち

各部屋には、専門の案内人がいました。

**ウィスパーモデルの案内人：**
「現在のモデルは large-v3 ですね」案内人は説明しました。「より軽量なモデルをお求めなら small や medium も選択できます。精度を重視するなら、現在の設定が最適です」

**録音デバイスの案内人：**
「利用可能な録音デバイス一覧をご確認ください」案内人はリストを見せました。
```
利用可能な録音デバイス:
1. MacBook Proの内蔵マイク (現在)
2. BlackHole 2ch [仮想デバイス]
3. 外付けUSBマイク
4. Bluetooth ヘッドセット
```

「仮想デバイスを選択すれば、システム音声の録音も可能です」案内人は説明しました。

### 変更確認の儀式 - チェンジ・コンファメーション

設定を変更した後は、必ず確認の儀式が行われました。

「設定を変更しました。保存いたしますか？」
- `s` - 保存して終了
- `q` - 保存せずに終了（確認あり）

「未保存の変更がある場合は、警告が表示されます」導師は注意しました。「誤操作を防ぐためです」

---

## 第十一章：ユーザーインターフェースの魔法（UI システム）

### ダッシュボードの魔法使い - ダッシュボード・マジシャン

王国の現在の状況を一目で把握できるよう、「**ダッシュボードの魔法使い**」が美しい表示を作成していました。

「情報の海から、重要なものだけを選んで美しく表示するのが私の仕事です」マジシャンは色とりどりの魔法の粉を撒きながら言いました。

**TUIダッシュボードの魔法：**
```
╭─────────────── KoeMoji-Go Dashboard ───────────────╮
│ 🎤 Status: Ready                   ⏰ 稼働時間: 2h34m │
│ 📁 Queue: 3 files                  💾 Queue: 0 files │
│ ⚡ Processing: audio1.wav           📊 CPU: 45%       │
│ 🔴 Recording: ●REC 00:45           🌐 Language: ja   │
│                                                      │
│ Recent Logs:                                         │
│ [INFO] 15:23:45 - スキャン完了                        │
│ [PROC] 15:23:50 - audio1.wav 処理中...               │
│ [DONE] 15:24:15 - 処理完了 (25秒)                     │
╰──────────────────────────────────────────────────╯
```

### 色彩の精霊 - カラー・スピリット

ダッシュボードには、「**色彩の精霊**」が美しい色を添えていました。

```go
const (
    ColorReset  = "\033[0m"   // 無色
    ColorRed    = "\033[31m"  // ERROR用
    ColorGreen  = "\033[32m"  // DONE用
    ColorYellow = "\033[33m"  // PROC用
    ColorBlue   = "\033[34m"  // INFO用
    ColorGray   = "\033[37m"  // DEBUG用
)
```

「色は情報を素早く理解するための重要な手がかりです」精霊は虹色の羽を広げました。「エラーは赤、完了は緑、処理中は黄色...これは人間の直感に合致しています」

### 多言語の通訳 - マルチランゲージ・インタープリター

王国では、世界中の人々を歓迎するため、「**多言語の通訳**」が働いていました。

**英語メッセージの例：**
```go
messagesEN := Messages{
    ConfigTitle:     "KoeMoji-Go Configuration",
    WhisperModel:    "Whisper Model",
    ProcessingFile:  "Processing file %s...",
    ProcessComplete: "Processing completed for %s (duration: %s)",
}
```

**日本語メッセージの例：**
```go
messagesJA := Messages{
    ConfigTitle:     "KoeMoji-Go 設定",
    WhisperModel:    "Whisperモデル",
    ProcessingFile:  "%s を処理中...",
    ProcessComplete: "%s の処理が完了しました (時間: %s)",
}
```

「設定で UI言語を選択すると、全てのメッセージが自動的に切り替わります」通訳は流暢に説明しました。

### リフレッシュの妖精 - リフレッシュ・フェアリー

画面の更新は、小さな「**リフレッシュの妖精**」が担当していました。

**TUIモードでの更新：**
- ユーザーがエンターキーを押した時
- ファイル処理が完了した時
- 録音状態が変化した時
- 設定が変更された時

**GUIモードでの更新：**
- 5秒ごとの自動更新
- ユーザーアクションの即時反映

「適切なタイミングでの更新が、快適なユーザーエクスペリエンスの鍵です」妖精は素早く画面を飛び回りながら言いました。

---

## 第十二章：デバイス管理の技師（デバイス管理）

### 音響デバイスの探偵 - オーディオ・ディテクティブ

録音システムでは、「**音響デバイスの探偵**」が利用可能なデバイスを調査していました。

「この調査により、接続されている全ての音響デバイスを特定できます」探偵は虫眼鏡を持ちながら説明しました。

**調査の手順：**
```go
func ListDevices() ([]DeviceInfo, error) {
    // PortAudio システム初期化
    err := portaudio.Initialize()
    defer portaudio.Terminate()
    
    // 全デバイス取得
    devices, err := portaudio.Devices()
    
    // 入力デバイスのみフィルタリング
    for _, device := range devices {
        if device.MaxInputChannels > 0 {
            // 詳細情報を収集
        }
    }
}
```

### 仮想デバイスの識別士 - バーチャル・アイデンティファイアー

特に興味深いのは、「**仮想デバイスの識別士**」の仕事でした。

「仮想デバイスは特別な能力を持っています」識別士は説明しました。「システムで再生されている音声を直接録音できるのです」

**仮想デバイスの種類：**
- **macOS**: BlackHole、Aggregate Device
- **Windows**: Stereo Mix、What U Hear

```go
func detectVirtualDevice(device *portaudio.DeviceInfo) (bool, string) {
    name := strings.ToLower(device.Name)
    
    switch runtime.GOOS {
    case "darwin":
        if strings.Contains(name, "blackhole") {
            return true, "BlackHole"
        }
    case "windows":
        if strings.Contains(name, "stereo mix") {
            return true, "Stereo Mix"
        }
    }
    return false, ""
}
```

「これらのデバイスは `[仮想デバイス]` と表示され、特別な用途に使用できます」識別士は誇らしげに言いました。

### デフォルトデバイスの守護者 - デフォルト・ガーディアン

「デフォルトデバイスの選択は重要な判断です」守護者は厳格に言いました。「ユーザーが特別な指定をしない限り、最も適切なデバイスを自動選択します」

```go
if app.Config.RecordingDeviceID == -1 {
    app.recorder, err = recorder.NewRecorder()  // デフォルト使用
} else {
    app.recorder, err = recorder.NewRecorderWithDevice(deviceID)  // 指定デバイス
}
```

---

## エピローグ：王国の未来

### 進化し続ける王国

KoeMoji-Go王国は、常に進化し続けていました。新しい魔法使いが加わり、既存のシステムがより効率的になり、新しい機能が追加されていきます。

### KISS原則の哲学

「Keep It Simple, Stupid」- これが王国の基本哲学でした。

「複雑さは悪です」王国の賢者は語りました。「単純で理解しやすいシステムこそが、長期的な成功をもたらします」

**KISS原則の実践例：**
- 録音状態は `recorder.Recorder` のみで管理
- エラーハンドリングの階層化
- 明確な責任分離
- 直感的なユーザーインターフェース

### 拡張性の設計

王国は将来の拡張を考慮して設計されていました。

**拡張可能な要素：**
- 新しい音声ファイル形式のサポート
- 追加のLLMプロバイダー統合
- 新しい出力フォーマット
- 高度な録音機能

### セキュリティの要塞

王国は堅固なセキュリティで守られていました。

**セキュリティ対策：**
- ファイルパスの厳格な検証
- 入力ディレクトリ外アクセスの禁止
- 適切なリソース制限
- 安全な設定値の検証

### 効率性の追求

王国の全システムは効率性を重視して設計されていました。

**効率化の工夫：**
- メモリ効率的な録音システム
- 並行処理による応答性向上
- 適切なリソース管理
- グレースフルシャットダウン

---

## 終章：物語の教訓

この長い物語を通じて、KoeMoji-Go王国の全貌が明らかになりました。

### 技術的な教訓

1. **単一責任原則**: 各コンポーネントが明確な役割を持つ
2. **適切な抽象化**: インターフェースによる柔軟性の確保
3. **エラーハンドリング**: 段階的な対応による堅牢性
4. **リソース管理**: メモリとCPUの効率的な使用
5. **ユーザビリティ**: 直感的で使いやすいインターフェース

### 設計哲学の教訓

1. **KISS原則**: シンプルさこそが美徳
2. **拡張性**: 将来の変更に対応できる設計
3. **保守性**: 理解しやすく修正しやすいコード
4. **セキュリティ**: 安全性を最優先に考慮
5. **効率性**: リソースを無駄にしない設計

### 実装の教訓

1. **並行処理**: ゴルーチンによる効率的な並行処理
2. **状態管理**: 最小限の状態で最大の機能を実現
3. **設定管理**: 柔軟で直感的な設定システム
4. **ログ管理**: 適切なレベル分けと効率的な記録
5. **UI設計**: TUIとGUIの適切な選択肢の提供

---

## あとがき：開発者への感謝

この壮大な物語の舞台となったKoeMoji-Go王国は、一人の開発者の情熱と技術によって作り上げられました。音声を文字に変換するという魔法は、実は最新のAI技術と丁寧なソフトウェア工学の結晶なのです。

コードレビューという探検を通じて発見されたように、この王国は非常によく設計され、実装されています。小さな改善点はありますが、全体的に素晴らしい品質を保っています。

この物語が、プログラムの構造と動作の理解に役立つことを願っています。技術的な詳細を物語という形で表現することで、複雑なシステムもより親しみやすく、理解しやすくなるはずです。

最後に、KoeMoji-Go王国の全ての住民（コンポーネント）に感謝を込めて。彼らの協力により、人間の声が美しい文字に変換される魔法が、今日も王国のどこかで静かに実行されているのです。

---

*この物語は、プログラマーの想像力と技術愛によって紡がれました。*
*実際のコードとシステムの詳細は、技術文書をご参照ください。*

**文字数: 約20,000字**

---

## 付録：登場人物一覧

### 主要キャラクター
- **メイン・ガーディアン** - アプリケーション起動の門番
- **フィーネ・プリンセス** - GUI宮殿の女王
- **ターミナル・マスター** - TUI宮殿の書記官
- **プロセッサー・ナイト** - ファイル処理の騎士
- **ウィスパー・アーキメイジ** - 音声転写の大魔法使い
- **レコーダー・エンジニア** - 録音システムの天才技師

### 支援キャラクター
- **ログの精霊** - 記録の管理者
- **スキャナー・エクスプローラー** - ファイル探索隊長
- **キュー・マネージャー** - 処理待ち宿屋の女将
- **サマリー・ポエット** - LLM要約の詩人
- **アーカイブ・リブラリアン** - 保管図書館の司書

### 技術専門家
- **オーディオ・アルケミスト** - 音響錬金術師
- **プログレス・フェアリー** - 進捗報告の妖精
- **コンフィグ・アーキビショップ** - 設定管理の大司教
- **グレースフル・ナイツ** - 安全終了の騎士団
- **マルチランゲージ・インタープリター** - 多言語通訳