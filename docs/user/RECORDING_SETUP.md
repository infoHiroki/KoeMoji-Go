# 録音機能セットアップガイド

KoeMoji-Goの録音機能を使用して、マイク音声やシステム音声を録音する方法を説明します。

## 📋 目次

- [基本的な録音](#基本的な録音)
- [macOS: システム音声+マイク同時録音](#macos-システム音声マイク同時録音)
- [Windows: システム音声+マイク同時録音](#windows-システム音声マイク同時録音)
- [録音デバイスの設定](#録音デバイスの設定)
- [トラブルシューティング](#トラブルシューティング)

## 基本的な録音

### 1. マイクのみ録音
最もシンプルな録音方法です。

1. KoeMoji-Goを起動
2. `r`キーを押して録音開始
3. 🔴録音中 - 経過時間が表示されます
4. 再度`r`キーを押して録音停止
5. `input/recording_YYYYMMDD_HHMM.wav`として保存
6. 次回スキャンで自動的に文字起こし開始

### 2. 録音ファイルの保存場所
- **保存先**: `input/`ディレクトリ
- **ファイル名**: `recording_20240623_1430.wav`（録音開始時刻）
- **形式**: WAV（16bit, 44.1kHz, モノラル）

## macOS: システム音声+マイク同時録音

macOSでシステム音声（アプリの音声）とマイクを同時に録音するには、BlackHoleという仮想オーディオデバイスを使用します。

### BlackHoleのインストール

#### Homebrewを使用（推奨）
```bash
brew install blackhole-2ch
```

#### 手動インストール
1. [BlackHole公式サイト](https://existential.audio/blackhole/)からダウンロード
2. `BlackHole2ch.pkg`をインストール
3. システム再起動

### 集約デバイスの作成

1. **Audio MIDI設定**を開く
   - アプリケーション → ユーティリティ → Audio MIDI設定

2. **集約デバイス**を作成
   - 左下の「+」→「集約デバイスを作成」
   - 名前を「KoeMoji-Go集約デバイス」等に変更

3. **デバイスを選択**
   - ✅ 内蔵マイク（または使用するマイク）
   - ✅ BlackHole 2ch
   - **重要**: マイクを最初（上側）に配置

4. **マルチ出力デバイス**を作成（音を聞きながら録音する場合）
   - 左下の「+」→「マルチ出力デバイスを作成」
   - ✅ 内蔵スピーカー
   - ✅ BlackHole 2ch

### KoeMoji-Goでの設定

1. `c`キーで設定画面を開く
2. 項目18「録音デバイス」で作成した集約デバイスを選択
3. 設定を保存

### 使用方法

1. **システム出力をBlackHoleに変更**
   - システム環境設定 → サウンド → 出力
   - 「BlackHole 2ch」または「マルチ出力デバイス」を選択

2. **録音開始**
   - KoeMoji-Goで`r`キーを押す
   - システム音声とマイクが同時録音されます

## Windows: システム音声+マイク同時録音

Windowsでシステムサウンドとマイクを同時に録音するには、VoiceMeeterという無料の仮想ミキサーを使用します。

### VoiceMeeterのインストール

1. [VoiceMeeter公式サイト](https://vb-audio.com/Voicemeeter/)にアクセス
2. **VoiceMeeter Basic**（無料版）をダウンロード
3. インストーラーを実行
4. **システム再起動**（重要）

### VoiceMeeterの設定

#### 1. 基本設定
1. **VoiceMeeter**を起動
2. **Hardware Input 1**: マイクを選択
3. **Hardware Input 2**: 「WDM: スピーカー」を選択
4. **A1**: 使用するスピーカー/ヘッドホンを選択

#### 2. 入力設定
- **Input 1（マイク）**: 
  - A1: ON（スピーカーに出力）
  - B1: ON（VoiceMeeter Outputに送信）
- **Input 2（システム音）**:
  - A1: ON（スピーカーに出力）  
  - B1: ON（VoiceMeeter Outputに送信）

#### 3. Windowsサウンド設定
1. **再生デバイス設定**
   - 設定 → システム → サウンド
   - 出力デバイス: 「VoiceMeeter Input (VB-Audio VoiceMeeter VAIO)」

2. **録音デバイス設定**
   - KoeMoji-Goでは「VoiceMeeter Output」を使用

### KoeMoji-Goでの設定

#### 方法1: 自動設定ボタン（推奨、v1.5.5以降）

1. `c`キーで設定画面を開く
2. 「録音」タブを選択
3. **「VoiceMeeter設定を適用」ボタン**をクリック
4. VoiceMeeter Outputが自動的に選択され、音量自動調整がONになります

#### 方法2: 手動設定

1. `c`キーで設定画面を開く
2. 「録音」タブで「録音デバイス」から「VoiceMeeter Output」を手動選択
3. 設定を保存

**注意**: VoiceMeeter設定ボタンはWindows環境でのみ表示されます。

### 使用方法

1. **VoiceMeeterを起動**（自動起動設定推奨）
2. **録音開始**
   - KoeMoji-Goで`r`キーを押す
   - システム音声とマイクがミックスされて録音されます

### VoiceMeeterの音量調整

- **マイク音量**: Hardware Input 1のフェーダー
- **システム音量**: Hardware Input 2のフェーダー
- **全体音量**: Master Sectionで調整

## 音量自動調整機能

KoeMoji-Goは録音音量が小さい場合に自動で増幅する機能を搭載しています（v1.5.5以降）。

### 仕組み
- 録音停止時に音量を自動測定
- 最大振幅が5000未満の場合のみ、目標レベル20000まで増幅
- クリッピング防止機能付き

### 設定方法
1. 設定画面の「録音」タブを開く
2. 「音量自動調整（推奨）」チェックボックスでON/OFF切り替え
3. デフォルト: ON

### 対応環境
- ✅ Windows: 全デバイス対応
- ✅ macOS: 全デバイス対応（BlackHole、集約デバイス含む）

この機能はプラットフォーム非依存で、どの録音デバイスでも利用できます。

## 録音デバイスの設定

### 利用可能デバイスの確認

1. `c`キーで設定画面を開く
2. 項目18「録音デバイス」を選択
3. 利用可能なデバイス一覧が表示されます

### デバイス種別の表示

- **📱 標準デバイス**: 通常のマイク
- **🎛️ 仮想デバイス**: BlackHole、VoiceMeeter等
- **🔧 集約デバイス**: 複数デバイスの組み合わせ

### 推奨設定

| 用途 | macOS | Windows |
|------|-------|---------|
| マイクのみ | 内蔵マイク | 既定のマイク |
| システム音のみ | BlackHole | Stereo Mix* |
| 両方同時 | 集約デバイス | VoiceMeeter Output |

*Stereo Mixは多くの環境で無効化されています

## トラブルシューティング

### 録音できない場合

#### macOS
```bash
# PortAudio依存関係を再インストール
brew reinstall portaudio pkg-config

# マイクアクセス許可を確認
# システム環境設定 → セキュリティとプライバシー → マイク
```

#### Windows
```bash
# VoiceMeeterサービスの再起動
# タスクマネージャー → サービス → "VoiceMeeter" を再起動

# または完全再インストール
```

### 音声が聞こえない・途切れる

#### macOS
1. **Audio MIDI設定**で集約デバイスの順序を確認
2. サンプリングレートを44.1kHzに統一
3. マルチ出力デバイスでスピーカーも選択

#### Windows  
1. **VoiceMeeter**でA1出力が選択されているか確認
2. Windows音量ミキサーでアプリ音量を確認
3. VoiceMeeter再起動

### 録音音量が小さい/大きい

#### 共通
- KoeMoji-Go設定では音量調整不可
- 元デバイス（VoiceMeeter/Audio MIDI設定）で調整

#### macOS
- Audio MIDI設定 → 集約デバイス → 各入力の音量調整

#### Windows
- VoiceMeeter → Hardware Inputのフェーダー調整

### デバイスが認識されない

1. **アプリ再起動**: KoeMoji-Goを完全終了して再起動
2. **システム再起動**: 仮想デバイス認識の問題
3. **権限確認**: マイクアクセス許可の確認

### その他のエラー

エラーメッセージは`koemoji.log`に記録されます。詳細な情報が必要な場合は、このログファイルを確認してください。

```bash
# ログ表示（実行中）
l キーを押す

# ログファイル直接確認
cat koemoji.log | tail -20
```

## 高度な設定

### 録音品質の設定

現在の仕様:
- **サンプリングレート**: 44.1kHz（固定）
- **ビット深度**: 16bit（固定）
- **チャンネル**: モノラル（固定）

### 録音時間制限

将来のバージョンで録音時間・ファイルサイズ制限機能が追加予定です。

### プロファイル管理

異なる録音シナリオに応じた設定プロファイルの保存機能も検討中です。

---

## 📞 サポート

問題が解決しない場合は、以下の情報と共にお問い合わせください：

1. OS種別とバージョン
2. 使用している仮想オーディオデバイス
3. `koemoji.log`の関連エラーメッセージ
4. 録音デバイス一覧（設定画面で確認可能）