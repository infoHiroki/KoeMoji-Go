# 録音機能セットアップガイド

KoeMoji-Goの録音機能を使用して、マイク音声やシステム音声を録音する方法を説明します。

## 📋 目次

- [基本的な録音](#基本的な録音)
- [macOS: システム音声+マイク同時録音](#macos-システム音声マイク同時録音)
- [Windows: システム音声+マイク同時録音](#windows-システム音声マイク同時録音)
- [録音デバイスの設定](#録音デバイスの設定)
- [トラブルシューティング](#トラブルシューティング)

## 基本的な録音

### 1. マイクのみ録音
最もシンプルな録音方法です。

1. KoeMoji-Goを起動
2. `r`キーを押して録音開始
3. 🔴録音中 - 経過時間が表示されます
4. 再度`r`キーを押して録音停止
5. `input/recording_YYYYMMDD_HHMM.wav`として保存
6. 次回スキャンで自動的に文字起こし開始

### 2. 録音ファイルの保存場所
- **保存先**: `input/`ディレクトリ
- **ファイル名**: `recording_20240623_1430.wav`（録音開始時刻）
- **形式**: WAV（16bit, 44.1kHz, モノラル）

## macOS: システム音声+マイク同時録音

macOSでシステム音声（アプリの音声）とマイクを同時に録音するには、BlackHoleという仮想オーディオデバイスを使用します。

### BlackHoleのインストール

#### Homebrewを使用（推奨）
```bash
brew install blackhole-2ch
```

#### 手動インストール
1. [BlackHole公式サイト](https://existential.audio/blackhole/)からダウンロード
2. `BlackHole2ch.pkg`をインストール
3. システム再起動

### 集約デバイスの作成

1. **Audio MIDI設定**を開く
   - アプリケーション → ユーティリティ → Audio MIDI設定

2. **集約デバイス**を作成
   - 左下の「+」→「集約デバイスを作成」
   - 名前を「KoeMoji-Go集約デバイス」等に変更

3. **デバイスを選択**
   - ✅ 内蔵マイク（または使用するマイク）
   - ✅ BlackHole 2ch
   - **重要**: マイクを最初（上側）に配置

4. **マルチ出力デバイス**を作成（音を聞きながら録音する場合）
   - 左下の「+」→「マルチ出力デバイスを作成」
   - ✅ 内蔵スピーカー
   - ✅ BlackHole 2ch

### KoeMoji-Goでの設定

1. `c`キーで設定画面を開く
2. 項目18「録音デバイス」で作成した集約デバイスを選択
3. 設定を保存

### 使用方法

1. **システム出力をBlackHoleに変更**
   - システム環境設定 → サウンド → 出力
   - 「BlackHole 2ch」または「マルチ出力デバイス」を選択

2. **録音開始**
   - KoeMoji-Goで`r`キーを押す
   - システム音声とマイクが同時録音されます

## Windows: システム音声+マイク同時録音

Windowsでシステムサウンドとマイクを同時に録音するには、VoiceMeeterという無料の仮想ミキサーを使用します。

### VoiceMeeterのインストール

1. [VoiceMeeter公式サイト](https://vb-audio.com/Voicemeeter/)にアクセス
2. **VoiceMeeter**（Basic、Banana、Potatoのいずれか）をダウンロード
   - **Basic**: 基本機能のみ
   - **Banana**: 推奨（Virtual Inputs 2つ、より柔軟）
   - **Potato**: 上級者向け
3. インストーラーを実行
4. **システム再起動**（重要）

### VoiceMeeterの基本用語

#### 出力バスの種類

**A系（A1, A2, A3）** = ハードウェア出力（スピーカー/ヘッドフォン）
- 用途: 音を聞くため（モニタリング）
- 設定: 物理デバイスを指定
- 例: A1に「Speakers (Realtek)」を設定

**B系（B1, B2）** = 仮想出力（録音用）
- 用途: 録音デバイスとしてWindowsに公開
- 設定: 何も指定しない（自動的にWindowsに表示される）
- 例: B1 → Windowsに「VoiceMeeter Output」として表示

#### ルーティングボタン

各入力チャンネルの下部にあるボタン：
- **A1ボタン（緑）**: A1（スピーカー）に音を送る → 音が聞こえる
- **B1ボタン（緑）**: B1（仮想出力）に音を送る → 録音できる
- **両方ON**: スピーカーで聞きながら録音可能

### VoiceMeeterの設定（詳細手順）

#### ステップ1: Windowsサウンド設定（出力）

1. **Windowsの設定を開く**
   - 設定 → システム → サウンド → 出力

2. **出力デバイスを変更**
   ```
   出力デバイス: Voicemeeter Input (VB-Audio Voicemeeter VAIO)
   ```

**効果**: YouTubeやブラウザの音がVoiceMeeterに送られます

#### ステップ2: Windowsサウンド設定（入力）

1. **Windowsの設定を開く**
   - 設定 → システム → サウンド → 入力

2. **入力デバイスを変更**
   ```
   入力デバイス: Voicemeeter Out B1 (VB-Audio Voicemeeter VAIO)
   ```

**重要**:
- ❌ **A1を選択しない**（A1はスピーカー出力用）
- ✅ **B1を選択**（B1は録音出力用）

#### ステップ3: VoiceMeeter設定

##### 3-1. MASTER SECTION（右側）

**A1（Hardware Out）**:
```
物理スピーカー/ヘッドフォンを選択
例: Speakers (Realtek High Definition Audio)
```

**B1（Virtual Output）**:
```
何も設定しない（自動的にWindowsに表示される）
```

##### 3-2. VIRTUAL INPUTS（中央）

**Voicemeeter Input（システム音が入力される場所）**:
- 下部のボタン: **A1 = ON（緑）**, **B1 = ON（緑）**
- 効果: システム音がスピーカーから聞こえる + 録音される

**Voicemeeter AUX I**（Bananaの場合、使用する場合）:
- 下部のボタン: **A1 = ON**, **B1 = ON**

##### 3-3. HARDWARE INPUT 1（左側）

**Stereo Input 1（マイク）**:
1. 上部をクリックしてマイクデバイスを選択
2. 下部のボタン:
   - **A1 = OFF（グレー）** ← **重要！**
   - **B1 = ON（緑）**

**注意**:
- ❌ **A1をONにしない**（自分の声がスピーカーから聞こえてハウリングする）
- ✅ **B1のみON**（録音のみに送る）

### KoeMoji-Goでの設定

#### 方法1: 自動設定ボタン（推奨、v1.5.5以降）

1. `c`キーで設定画面を開く
2. 「録音」タブを選択
3. **「VoiceMeeter設定を適用」ボタン**をクリック
4. VoiceMeeter Outputが自動的に選択され、音量自動調整がONになります

#### 方法2: 手動設定

1. `c`キーで設定画面を開く
2. 「録音」タブで「録音デバイス」から「VoiceMeeter Output」を手動選択
3. 設定を保存

**注意**: VoiceMeeter設定ボタンはWindows環境でのみ表示されます。

### 使用方法

1. **VoiceMeeterを起動**（自動起動設定推奨）
2. **録音開始**
   - KoeMoji-Goで`r`キーを押す
   - システム音声とマイクがミックスされて録音されます

### VoiceMeeterの音量調整

- **マイク音量**: Hardware Input 1のフェーダー
- **システム音量**: Hardware Input 2のフェーダー
- **全体音量**: Master Sectionで調整

## 音量自動調整機能

KoeMoji-Goは録音音量が小さい場合に自動で増幅する機能を搭載しています（v1.5.5以降）。

### 仕組み
- 録音停止時に音量を自動測定
- 最大振幅が5000未満の場合のみ、目標レベル20000まで増幅
- クリッピング防止機能付き

### 設定方法
1. 設定画面の「録音」タブを開く
2. 「音量自動調整（推奨）」チェックボックスでON/OFF切り替え
3. デフォルト: ON

### 対応環境
- ✅ Windows: 全デバイス対応
- ✅ macOS: 全デバイス対応（BlackHole、集約デバイス含む）

この機能はプラットフォーム非依存で、どの録音デバイスでも利用できます。

## 録音デバイスの設定

### 利用可能デバイスの確認

1. `c`キーで設定画面を開く
2. 項目18「録音デバイス」を選択
3. 利用可能なデバイス一覧が表示されます

### デバイス種別の表示

- **📱 標準デバイス**: 通常のマイク
- **🎛️ 仮想デバイス**: BlackHole、VoiceMeeter等
- **🔧 集約デバイス**: 複数デバイスの組み合わせ

### 推奨設定

| 用途 | macOS | Windows |
|------|-------|---------|
| マイクのみ | 内蔵マイク | 既定のマイク |
| システム音のみ | BlackHole | Stereo Mix* |
| 両方同時 | 集約デバイス | VoiceMeeter Output |

*Stereo Mixは多くの環境で無効化されています

## トラブルシューティング

### 録音できない場合

#### macOS
```bash
# PortAudio依存関係を再インストール
brew reinstall portaudio pkg-config

# マイクアクセス許可を確認
# システム環境設定 → セキュリティとプライバシー → マイク
```

#### Windows
```bash
# VoiceMeeterサービスの再起動
# タスクマネージャー → サービス → "VoiceMeeter" を再起動

# または完全再インストール
```

### 音声が聞こえない・途切れる

#### macOS
1. **Audio MIDI設定**で集約デバイスの順序を確認
2. サンプリングレートを44.1kHzに統一
3. マルチ出力デバイスでスピーカーも選択

#### Windows  
1. **VoiceMeeter**でA1出力が選択されているか確認
2. Windows音量ミキサーでアプリ音量を確認
3. VoiceMeeter再起動

### 自分の声がスピーカーから聞こえる（Windows + VoiceMeeter）

**症状**:
- マイクに話すと、自分の声がスピーカーから聞こえる
- ハウリングやエコーが発生する

**原因**:
- VoiceMeeterのHARDWARE INPUT 1（マイク）のA1ボタンがONになっている

**解決策**:
1. VoiceMeeterを開く
2. HARDWARE INPUT 1（マイク）の下部ボタンを確認
3. **A1をクリックしてOFF（グレー）にする**
4. **B1はON（緑）のまま**

**正しい設定**:
```
HARDWARE INPUT 1（マイク）:
- A1: OFF（グレー） ← 自分の声を聞かない
- B1: ON（緑）     ← 録音する
```

### VoiceMeeter Out A1で録音できない（Windows）

**症状**:
- Windowsの入力デバイスを「Voicemeeter Out A1」に設定している
- 録音がうまく動作しない

**原因**:
- A1はスピーカー出力用で、録音用ではない
- 録音にはB1を使用する必要がある

**解決策**:
1. Windowsの設定 → システム → サウンド → 入力
2. **入力デバイスを「Voicemeeter Out B1」に変更**
3. KoeMoji-Goを再起動

### 録音音量が小さい/大きい

#### 共通
- KoeMoji-Go設定では音量調整不可
- 元デバイス（VoiceMeeter/Audio MIDI設定）で調整

#### macOS
- Audio MIDI設定 → 集約デバイス → 各入力の音量調整

#### Windows
- VoiceMeeter → Hardware Inputのフェーダー調整
- マイクとシステム音のバランス調整が可能

### デバイスが認識されない

1. **アプリ再起動**: KoeMoji-Goを完全終了して再起動
2. **システム再起動**: 仮想デバイス認識の問題
3. **権限確認**: マイクアクセス許可の確認

### その他のエラー

エラーメッセージは`koemoji.log`に記録されます。詳細な情報が必要な場合は、このログファイルを確認してください。

```bash
# ログ表示（実行中）
l キーを押す

# ログファイル直接確認
cat koemoji.log | tail -20
```

## 高度な設定

### 録音品質の設定

現在の仕様:
- **サンプリングレート**: 44.1kHz（固定）
- **ビット深度**: 16bit（固定）
- **チャンネル**: モノラル（固定）

### 録音時間制限

将来のバージョンで録音時間・ファイルサイズ制限機能が追加予定です。

### プロファイル管理

異なる録音シナリオに応じた設定プロファイルの保存機能も検討中です。

---

## 📞 サポート

問題が解決しない場合は、以下の情報と共にお問い合わせください：

1. OS種別とバージョン
2. 使用している仮想オーディオデバイス
3. `koemoji.log`の関連エラーメッセージ
4. 録音デバイス一覧（設定画面で確認可能）