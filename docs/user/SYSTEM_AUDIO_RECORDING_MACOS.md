# macOS環境でシステム音声とマイク音声を同時録音する設定

このドキュメントでは、KoeMoji-GoでmacOSのシステム音声（YouTube、Zoom等）とマイク音声を同時に録音する方法を説明します。

## 概要

macOS版のKoeMoji-Goでは、macOS 13以降で利用可能なScreenCaptureKit APIを使用してシステム音声を録音します。これにより、**仮想オーディオデバイス（BlackHole等）を使わずに**、システム音声とマイク音声の同時録音が可能です。

## システム要件

- **macOS 13 Ventura以降** （macOS 13, 14, 15で動作確認済み）
- **画面収録権限** （初回実行時にシステムが要求）
- KoeMoji-Go **v1.8.0以降**

## セットアップ手順

### 1. デュアル録音機能の有効化

KoeMoji-Goのデフォルト設定ではデュアル録音は無効になっています。以下の手順で有効にします。

#### GUIモード
1. KoeMoji-Goを起動
2. 「⚙️ 設定」ボタンをクリック
3. 「録音」タブを選択
4. **録音モード**で「デュアル録音（システム音声+マイク）」を選択
5. 画面に「※ macOS 13以降、画面収録権限が必要です」と表示されることを確認
6. 「保存」ボタンをクリック

#### TUIモード
1. KoeMoji-Goを起動: `./koemoji-go --tui`
2. `c`キーを押して設定画面を開く
3. `config.json`で直接編集:
   ```json
   {
     "dual_recording_enabled": true
   }
   ```

### 2. 画面収録権限の許可

デュアル録音を有効にして初めて録音を開始すると、macOSが画面収録権限を要求します。

1. 録音ボタン（GUI）または`r`キー（TUI）を押す
2. macOSのダイアログが表示されます：
   ```
   "KoeMoji-Go"が画面の記録を求めています
   [拒否] [許可]
   ```
3. **「許可」をクリック**
4. アプリが自動的に再起動します（権限適用のため）

> **注意**: 画面収録権限を拒否すると、システム音声の録音はできません（マイク録音のみ動作）

#### 権限を後から変更する場合

1. **システム設定** > **プライバシーとセキュリティ** > **画面収録**
2. KoeMoji-Goのトグルを**オン**に設定
3. アプリを再起動

### 3. 録音デバイスの選択（オプション）

マイク録音に使用するデバイスを変更できます。

1. 設定画面 > 録音タブ
2. 「録音デバイス」のドロップダウンから選択
   - **デフォルトデバイス**（推奨）
   - その他の利用可能なマイクデバイス

> **推奨**: 特別な理由がなければ「デフォルトデバイス」を使用してください

## 録音方法

### 録音開始
- **GUIモード**: 「🎤 録音」ボタンをクリック
- **TUIモード**: `r`キーを押す

### 録音停止と保存
1. もう一度録音ボタン（または`r`キー）を押す
2. ファイル名を入力
3. 2つのファイルが保存されます：
   - `ファイル名.wav` - マイク音声（44.1kHz, モノラル, Int16）
   - `ファイル名-system.wav` - システム音声（48kHz, ステレオ, Float32）

## 動作の仕組み

```
システム音声 → ScreenCaptureKit → system.wav (48kHz Stereo)
マイク音声   → PortAudio        → mic.wav (44.1kHz Mono)
```

macOS版のデュアル録音は**2ストリーム方式**です：
- システム音声とマイク音声は**別々のファイル**として保存されます
- それぞれ最適なフォーマットで録音されます
- 後から編集ソフトで合成可能（音量調整が容易）

### Windows版との違い

| 項目 | macOS版 | Windows版 |
|------|---------|-----------|
| 必要ソフト | なし | VB-Audio Virtual Cable |
| 仮想デバイス | 不要 | 必要 |
| ファイル数 | 2ファイル | 2ファイル |
| 音量調整UI | なし | あり（5段階） |
| 権限要求 | 画面収録権限 | なし |

## トラブルシューティング

### システム音声が録音されない

**原因**: 画面収録権限が許可されていない

**解決策**:
1. **システム設定** > **プライバシーとセキュリティ** > **画面収録**
2. KoeMoji-Goが**オン**になっているか確認
3. オフの場合はオンにして、アプリを再起動

### マイク音声が録音されない

**原因**: マイクアクセス権限が許可されていない

**解決策**:
1. **システム設定** > **プライバシーとセキュリティ** > **マイク**
2. KoeMoji-Goが**オン**になっているか確認
3. オフの場合はオンにして、アプリを再起動

### 録音ファイルが1つしか生成されない

**原因**: デュアル録音が無効になっている

**解決策**:
1. 設定画面で録音モードを確認
2. 「デュアル録音（システム音声+マイク）」を選択
3. 設定を保存してアプリを再起動

### エラー: "audio-capture binary not found"

**原因**: Swift CLIバイナリが見つからない

**解決策**:
- リリース版を使用している場合: `audio-capture`バイナリが同じフォルダにあるか確認
- 開発版の場合: `cmd/audio-capture/`ディレクトリに`audio-capture`バイナリがあるか確認

### macOS 12以前で使用したい

**制限**: macOS 12以前ではScreenCaptureKit APIが利用できません

**代替案**:
- シングル録音（マイクのみ）を使用
- または、BlackHole + 集約デバイスで手動設定（複雑）

## 音量調整について

現在のmacOS版では、UI上での音量調整機能は実装されていません。

### 録音後に音量を調整する方法

1. **Audacity**（無料、クロスプラットフォーム）
   - システム音声ファイルとマイクファイルを個別に読み込み
   - それぞれの音量を調整
   - ミックスして1つのファイルにエクスポート

2. **GarageBand**（macOS標準）
   - 2つのファイルを別トラックにドラッグ
   - トラックボリュームで調整

3. **Final Cut Pro / Adobe Audition**（プロ向け）
   - マルチトラック編集で自由に調整

### 将来のアップデート予定

v1.9.0以降で以下の機能を追加予定：
- [ ] UI上での音量プリセット（Windows版と同様）
- [ ] リアルタイム音量メーター表示
- [ ] 録音前のテスト録音機能

## 参考情報

### 技術詳細
- ScreenCaptureKit: macOS 13で導入されたシステム音声キャプチャAPI
- 録音フォーマット:
  - システム音声: 48kHz, Float32, Stereo (CAF → WAV自動変換)
  - マイク: 44.1kHz, Int16, Mono

### 関連リンク
- [KoeMoji-Go公式リポジトリ](https://github.com/infoHiroki/KoeMoji-Go)
- [Apple ScreenCaptureKit ドキュメント](https://developer.apple.com/documentation/screencapturekit)

---

**最終更新**: 2025-10-27
**対象バージョン**: v1.8.0以降
