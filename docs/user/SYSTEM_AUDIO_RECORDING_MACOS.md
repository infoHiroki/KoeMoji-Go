# macOS環境でシステム音声とマイク音声を同時録音する設定

このドキュメントでは、KoeMoji-GoでmacOSのシステム音声（YouTube、Zoom等）とマイク音声を同時に録音する方法を説明します。

## 概要

macOS版のKoeMoji-Goでは、macOS 13以降で利用可能なScreenCaptureKit APIを使用してシステム音声を録音します。これにより、**仮想オーディオデバイス（BlackHole等）を使わずに**、システム音声とマイク音声の同時録音が可能です。

### v1.8.0の改善点

- **FFmpeg不要**: Go言語での独自ミックス実装により、FFmpegのインストールが不要になりました
- **1ファイル出力**: システム音声とマイクを自動的にミックスし、1つのWAVファイルとして保存
- **シンプルなUX**: 2ファイル管理が不要で、inputフォルダでの重複文字起こしも発生しません

## システム要件

- **macOS 13 Ventura以降** （macOS 13, 14, 15で動作確認済み）
- **画面収録権限** （初回実行時にシステムが要求）
- KoeMoji-Go **v1.8.0以降**

## セットアップ手順

### 1. デュアル録音機能の有効化

KoeMoji-Goのデフォルト設定ではデュアル録音は無効になっています。以下の手順で有効にします。

#### GUIモード
1. KoeMoji-Goを起動
2. 「⚙️ 設定」ボタンをクリック
3. 「録音」タブを選択
4. **録音モード**で「デュアル録音（システム音声+マイク）」を選択
5. 画面に「※ macOS 13以降、画面収録権限が必要です」と表示されることを確認
6. 「保存」ボタンをクリック

#### TUIモード
1. KoeMoji-Goを起動: `./koemoji-go --tui`
2. `c`キーを押して設定画面を開く
3. `config.json`で直接編集:
   ```json
   {
     "dual_recording_enabled": true
   }
   ```

### 2. 画面収録権限の許可

デュアル録音を有効にして初めて録音を開始すると、macOSが画面収録権限を要求します。

1. 録音ボタン（GUI）または`r`キー（TUI）を押す
2. macOSのダイアログが表示されます：
   ```
   "KoeMoji-Go"が画面の記録を求めています
   [拒否] [許可]
   ```
3. **「許可」をクリック**
4. アプリが自動的に再起動します（権限適用のため）

> **注意**: 画面収録権限を拒否すると、システム音声の録音はできません（マイク録音のみ動作）

#### 権限を後から変更する場合

1. **システム設定** > **プライバシーとセキュリティ** > **画面収録**
2. KoeMoji-Goのトグルを**オン**に設定
3. アプリを再起動

### 3. 録音デバイスの選択（オプション）

マイク録音に使用するデバイスを変更できます。

1. 設定画面 > 録音タブ
2. 「録音デバイス」のドロップダウンから選択
   - **デフォルトデバイス**（推奨）
   - その他の利用可能なマイクデバイス

> **推奨**: 特別な理由がなければ「デフォルトデバイス」を使用してください

## 録音方法

### 録音開始
- **GUIモード**: 「🎤 録音」ボタンをクリック
- **TUIモード**: `r`キーを押す

### 録音停止と保存
1. もう一度録音ボタン（または`r`キー）を押す
2. ファイル名を入力
3. **1つの**ミックス済みファイルが保存されます：
   - `ファイル名.wav` - システム音声+マイク（48kHz, ステレオ, Int16）
   - システム音声: 70%音量、マイク: 100%音量で自動ミックス

## 動作の仕組み

```
システム音声 → ScreenCaptureKit (48kHz Stereo Float32)
                                            ↓
                                      [ミックス処理]
                                            ↓
マイク音声   → PortAudio (44.1kHz Mono) → リサンプリング → 48kHz Mono
                                            ↓
                                     mixed.wav (48kHz Stereo Int16)
```

macOS版v1.8.0の処理フロー：
1. **同時録音**: システム音声とマイク音声を別々に録音
2. **リサンプリング**: マイク音声を44.1kHz → 48kHzに変換（線形補間）
3. **ステレオ化**: モノラルのマイク音声を両チャンネルに配置
4. **音量調整**: システム70%、マイク100%
5. **ミックス**: 加算合成（クリッピング防止付き）
6. **保存**: 1つのWAVファイルとして出力

**技術的特徴**:
- FFmpeg不要（Go標準ライブラリのみ）
- 軽量（外部プロセス不要）
- クロスプラットフォーム対応

### Windows版との違い

| 項目 | macOS版 | Windows版 |
|------|---------|-----------|
| 必要ソフト | なし | なし |
| 仮想デバイス | 不要 | 不要 |
| ファイル数 | 1ファイル（ミックス済み） | 1ファイル（ミックス済み） |
| 音量調整UI | なし（config.jsonで調整） | あり（5段階プリセット） |
| 権限要求 | 画面収録権限 | なし |
| FFmpeg | 不要 | 不要 |

## トラブルシューティング

### システム音声が録音されない

**原因**: 画面収録権限が許可されていない

**解決策**:
1. **システム設定** > **プライバシーとセキュリティ** > **画面収録**
2. KoeMoji-Goが**オン**になっているか確認
3. オフの場合はオンにして、アプリを再起動

### マイク音声が録音されない

**原因**: マイクアクセス権限が許可されていない

**解決策**:
1. **システム設定** > **プライバシーとセキュリティ** > **マイク**
2. KoeMoji-Goが**オン**になっているか確認
3. オフの場合はオンにして、アプリを再起動

### 音量バランスが悪い（システム音声が小さい/大きい）

**原因**: デフォルト設定（システム70%, マイク100%）が環境に合っていない

**解決策**:
現在のバージョンでは音量比率は固定ですが、録音後に音量調整することをおすすめします：
- **Audacity**（無料）: エフェクト > 増幅
- **GarageBand**（macOS標準）: トラック音量
- **QuickTime Player**: 表示 > 音量を表示

### エラー: "audio-capture binary not found"

**原因**: Swift CLIバイナリが見つからない

**解決策**:
- リリース版を使用している場合: `audio-capture`バイナリが同じフォルダにあるか確認
- 開発版の場合: `cmd/audio-capture/`ディレクトリに`audio-capture`バイナリがあるか確認

### macOS 12以前で使用したい

**制限**: macOS 12以前ではScreenCaptureKit APIが利用できません

**代替案**:
- シングル録音（マイクのみ）を使用
- または、BlackHole + 集約デバイスで手動設定（複雑）

## 音量調整について

### デフォルト設定

v1.8.0では、以下の音量比率で自動ミックスされます：
- **システム音声**: 70% (0.7)
- **マイク音声**: 100% (1.0)

この比率は、一般的な使用環境（Zoom会議、YouTube視聴など）で最適なバランスとなるよう設定されています。

### 録音後に音量を調整する方法

環境によって音量バランスが合わない場合は、録音後に調整できます：

1. **Audacity**（無料、クロスプラットフォーム）
   - ファイルを開く
   - エフェクト > 増幅 で全体音量を調整
   - またはイコライザーで特定周波数を調整

2. **GarageBand**（macOS標準）
   - ファイルをドラッグ&ドロップ
   - トラック音量スライダーで調整

3. **QuickTime Player**（macOS標準、簡易調整）
   - 表示 > 音量を表示
   - スライダーで再生音量を調整（ファイルは変更されない）

### 2ファイル保存が必要な場合

話者分離や高度な音量調整が必要な場合は、開発者にお問い合わせください。
`SaveSeparateFiles()` APIを使用して、システム音声とマイクを別々のファイルとして保存することも可能です。

### 将来のアップデート予定

v1.9.0以降で以下の機能を追加予定：
- [ ] UI上での音量プリセット選択（システム50%/70%/100%、マイク70%/100%/150%）
- [ ] リアルタイム音量メーター表示
- [ ] 録音前のテスト録音機能
- [ ] 2ファイル保存オプション（GUI設定）

## 参考情報

### 技術詳細
- **ScreenCaptureKit**: macOS 13で導入されたシステム音声キャプチャAPI
- **録音フォーマット**:
  - システム音声: 48kHz Float32 Stereo (CAF → WAV自動変換)
  - マイク: 44.1kHz Int16 Mono → 48kHz Int16 Mono（リサンプリング）
  - 出力: 48kHz Int16 Stereo（ミックス済み）
- **ミックスアルゴリズム**:
  - リサンプリング: 線形補間（Linear Interpolation）
  - ステレオ化: モノラル音声を両チャンネルに配置
  - 音量調整: 乗算（システム×0.7、マイク×1.0）
  - 合成: 加算ミックス + ソフトクリッピング
- **実装言語**: Go（FFmpeg不要）

### 関連リンク
- [KoeMoji-Go公式リポジトリ](https://github.com/infoHiroki/KoeMoji-Go)
- [Apple ScreenCaptureKit ドキュメント](https://developer.apple.com/documentation/screencapturekit)

---

**最終更新**: 2025-10-27
**対象バージョン**: v1.8.0以降
