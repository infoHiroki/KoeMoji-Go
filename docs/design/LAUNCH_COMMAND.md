# macOSターミナルUI（TUI）モード起動スクリプト実装設計書

**作成日**: 2025-11-06
**最終更新**: 2025-11-06
**バージョン**: v2.0
**対象バージョン**: v1.8.5

---

## 📋 目次

1. [背景と目的](#背景と目的)
2. [技術仕様](#技術仕様)
3. [ファイル構成](#ファイル構成)
4. [実装手順](#実装手順)
5. [テスト計画](#テスト計画)
6. [既知の制約](#既知の制約)
7. [参考情報](#参考情報)

---

## 背景と目的

### 問題

現状、macOS版KoeMoji-GoのTUIモードを起動するには：
1. ターミナルを開く
2. `cd` コマンドでディレクトリに移動
3. `./koemoji-go --tui` を実行

この手順は**技術的に不慣れなユーザーにとってハードルが高い**。

### 目標

**ダブルクリックでTUIモードを起動できる**ようにする。

### なぜGUIモードではなくTUIモードか

**GUIモード起動スクリプトの問題**:
- ターミナルウィンドウが開くが、GUIアプリ終了後も残る
- ユーザーが手動でターミナルを閉じる必要がある
- ユーザー体験が悪い

**TUIモード起動スクリプトの利点**:
- TUIモードはターミナルが必要なので、ウィンドウが開くのは自然
- ターミナルが残ることが問題にならない
- 実用的なユーザー体験

### アプローチ

- `.command` スクリプト形式を使用（診断実行.commandと同じパターン）
- TUIモード専用（`--tui`フラグ使用）
- Issue #2（.appバンドル）とは別のアプローチ
- 署名不要、即座に実装可能
- メンテナンスコスト最小

---

## 技術仕様

### ファイル名

**最終決定**: `KoeMoji-Go-TUI.command`

**理由**:
- TUIモード起動であることが明確
- 将来的にGUI版やその他のバリエーションを追加する余地がある
- シンプルで視認性が高い

### スクリプト内容

```bash
#!/bin/bash
cd "$(dirname "$0")"
echo "===================================="
echo "  KoeMoji-Go TUIモード起動"
echo "===================================="
echo ""
./koemoji-go --tui
echo ""
echo "===================================="
echo "  KoeMoji-Go を終了しました"
echo "  このウィンドウを閉じてください"
echo "===================================="
```

**実装ポイント**:
- **行1-2**: シェバン、ディレクトリ移動
- **行3-6**: 起動メッセージ表示
- **行7**: TUIモード起動（`--tui`フラグ使用）
- **行8-12**: 終了メッセージ表示（明確な指示を含む）

**UX設計**:
- わかりやすいメッセージ表示
- 終了後に「このウィンドウを閉じてください」と明確に指示
- シンプルで無駄のない構成

### 実行権限

```bash
chmod +x KoeMoji-Go-TUI.command
```

- ビルド時に自動設定
- 解凍後もそのまま実行可能

### ファイルサイズ

- 実測: 380バイト
- 診断実行.command: 542バイト（参考）

---

## ファイル構成

### 追加・変更ファイル

#### 1. 新規ファイル

```
build/macos/KoeMoji-Go-TUI.command
```

#### 2. 変更ファイル

```
build/macos/build.sh          # パッケージング処理追加
README.md                      # TUI起動方法の記載追加
build/common/assets/README_RELEASE.md  # 配布版README更新
docs/design/LAUNCH_COMMAND.md  # 設計書更新
```

### 配布パッケージ構成（v1.8.5予定）

```
koemoji-go-macos-1.8.5.tar.gz
└── koemoji-go-1.8.5/
    ├── koemoji-go             # 本体バイナリ（GUI/TUI両対応）
    ├── audio-capture          # Swift CLI
    ├── config.json            # 設定ファイル
    ├── README.md              # ユーザーガイド
    ├── 診断実行.command       # 診断ツール（既存）
    └── KoeMoji-Go-TUI.command # ★TUIモード起動スクリプト（NEW）
```

---

## 実装手順

### ステップ1: スクリプト作成

1. `build/macos/KoeMoji-Go-TUI.command` を作成
2. 以下の内容を記述:
```bash
#!/bin/bash
cd "$(dirname "$0")"
echo "===================================="
echo "  KoeMoji-Go TUIモード起動"
echo "===================================="
echo ""
./koemoji-go --tui
echo ""
echo "===================================="
echo "  KoeMoji-Go を終了しました"
echo "  このウィンドウを閉じてください"
echo "===================================="
```
3. 実行権限付与: `chmod +x build/macos/KoeMoji-Go-TUI.command`

### ステップ2: build.sh更新

`build/macos/build.sh` の `create_tar_package()` 関数に追加:

```bash
# 診断実行.command の後に追加（220行目付近）

# Copy TUI launch script
cp "$SCRIPT_DIR/KoeMoji-Go-TUI.command" "$package_name/KoeMoji-Go-TUI.command"
chmod +x "$package_name/KoeMoji-Go-TUI.command"
```

**挿入位置**: 診断実行.commandコピーの直後（219-220行目の次）

### ステップ3: README.md更新

`README.md` の macOS実行セクションを更新:

**変更後**:
```markdown
3. **実行**:

   **方法1: ターミナルから実行（推奨）**
   ```bash
   ./koemoji-go          # GUI版（デフォルト）
   ./koemoji-go --tui    # TUI版
   ```

   **方法2: TUIモードをダブルクリックで起動**
   ```
   KoeMoji-Go-TUI.command をダブルクリック
   ```
```

### ステップ4: README_RELEASE.md更新

`build/common/assets/README_RELEASE.md` の macOS起動セクションを同様に更新。

---

## テスト計画

### 手動テスト項目

#### テスト1: ビルド確認

```bash
cd build/macos
./build.sh clean
./build.sh
```

**期待結果**:
- ✅ `KoeMoji-Go.command` がパッケージに含まれる
- ✅ 実行権限が設定されている (`-rwxr-xr-x`)

#### テスト2: 解凍後の確認

```bash
cd /tmp
tar -xzf path/to/koemoji-go-macos-1.8.5.tar.gz
cd koemoji-go-1.8.5
ls -la KoeMoji-Go.command
```

**期待結果**:
- ✅ ファイルが存在
- ✅ 実行権限がついている

#### テスト3: ダブルクリック起動

1. Finderでパッケージディレクトリを開く
2. `KoeMoji-Go-TUI.command` をダブルクリック
3. TUIモードが起動することを確認

**期待結果**:
- ✅ ターミナルウィンドウが開く
- ✅ KoeMoji-Go TUIモードが起動
- ✅ エラーが表示されない

#### テスト4: スクリプトの動作確認

```bash
cd /tmp/koemoji-go-1.8.5
./KoeMoji-Go-TUI.command
```

**期待結果**:
- ✅ TUIモード起動（ダブルクリックと同じ動作）

#### テスト5: 診断実行.command との共存確認

1. `診断実行.command` をダブルクリック
2. `KoeMoji-Go-TUI.command` をダブルクリック

**期待結果**:
- ✅ 両方が正常に動作
- ✅ 互いに干渉しない

---

## 既知の制約

### 制約1: アイコン表示

- ❌ カスタムアイコンは表示されない
- 表示されるアイコン: シェルスクリプトのデフォルトアイコン
- 回避策: Issue #2（.appバンドル）で対応予定

### 制約2: ターミナルウィンドウ

- ✅ 起動時にターミナルウィンドウが開く
- **TUIモードなので問題なし**（ターミナルが必要）
- ユーザー体験的に自然

### 制約3: 「アプリケーション」として認識されない

- ❌ Finderで「アプリケーション」カテゴリに表示されない
- 「書類」として扱われる
- 回避策: Issue #2（.appバンドル）で対応予定

### 制約4: GUIモードは非対応

- このスクリプトはTUIモード専用（`--tui`フラグ固定）
- GUIモードは従来通りターミナルから `./koemoji-go` で起動
- 理由: GUIモード用スクリプトはターミナルウィンドウが残る問題がありUXが悪い

---

## 参考情報

### Issue #2との関係

**Issue #2**: macOSアプリバンドル配布時にFasterWhisperチェックで強制終了する問題

- `.app` バンドル形式の実装
- Apple Developer Program（年12,980円）が理想的
- 現在は保留中（ユーザー要望があれば対応）

**本実装との違い**:
| 項目 | Issue #2 (.app) | 本実装 (.command) |
|------|----------------|------------------|
| 実装難易度 | 高 | 低 |
| 所要時間 | 2-3時間 | 30分 |
| 署名 | 推奨 | 不要 |
| アイコン | 表示可能 | 不可 |
| コスト | 年12,980円 | 無料 |
| ターミナル | 表示なし | 表示あり |
| アプリ認識 | あり | なし |

**方針**: 短期的に本実装で対応、長期的にIssue #2で本格対応を検討

### 診断実行.commandとの比較

| 項目 | 診断実行.command | KoeMoji-Go.command |
|------|-----------------|-------------------|
| 行数 | 21行 | 3行 |
| サイズ | 542バイト | 約60バイト |
| 機能 | 診断実行+結果保存 | 起動のみ |
| 終了処理 | read -p で待機 | なし（GUI継続） |

### Windows版との比較

**Windows版**:
- `.exe` ファイルを直接ダブルクリック
- 起動スクリプトは不要
- アイコン表示可能
- アプリケーションとして認識

**macOS版（本実装）**:
- `.command` スクリプトをダブルクリック
- Windows `.exe` に近いUX
- アイコン・アプリ認識は制限あり

---

## 実装チェックリスト

実装時に以下を確認してください：

### フェーズ1: ファイル作成
- [x] `build/macos/KoeMoji-Go-TUI.command` 作成
- [x] スクリプト内容記述（3行）
- [x] 実行権限付与 (`chmod +x`)
- [x] ファイルサイズ確認（57バイト）

### フェーズ2: ビルドスクリプト更新
- [x] `build/macos/build.sh` 編集
- [x] `cp "$SCRIPT_DIR/KoeMoji-Go-TUI.command"` 追加
- [x] `chmod +x "$package_name/KoeMoji-Go-TUI.command"` 追加
- [x] 診断実行.commandの直後に配置

### フェーズ3: ドキュメント更新
- [x] `README.md` のmacOS起動セクション更新
- [x] `build/common/assets/README_RELEASE.md` 更新
- [x] 「方法1: ターミナルから実行（推奨）」を記載
- [x] 「方法2: TUIモードをダブルクリックで起動」を追加
- [x] 設計ドキュメント更新（TUI版に変更）

### フェーズ4: テスト
- [ ] テスト1: ビルド確認（パッケージに含まれるか）
- [ ] テスト2: 解凍後の確認（実行権限あるか）
- [ ] テスト3: ダブルクリック起動（TUIモード起動するか）
- [ ] テスト4: スクリプトの動作確認（ターミナルから実行）
- [ ] テスト5: 診断実行.commandとの共存確認

### フェーズ5: コミット・リリース
- [ ] 変更をコミット
- [ ] v1.8.5としてリリース（または別バージョン）
- [ ] GitHub Releaseに記載
- [ ] ユーザーにアナウンス

---

## バージョン履歴

| バージョン | 日付 | 変更内容 |
|-----------|------|---------|
| v1.0 | 2025-11-06 | 初版作成（GUIモード起動スクリプト設計） |
| v2.0 | 2025-11-06 | TUIモード専用に変更（GUIモードはターミナルウィンドウが残る問題のため） |

---

**設計書作成者**: Claude Code
**実装**: 完了（v2.0）
**レビュー**: ユーザーレビュー済み
