# デュアル録音機能 設計書

**作成日**: 2025-10-23
**ステータス**: 🔍 設計フェーズ
**ブランチ**: `feature/dual-recording-system`

---

## 📋 目次
1. [背景と目的](#1-背景と目的)
2. [現状分析](#2-現状分析)
3. [要件定義](#3-要件定義)
4. [技術選択の比較](#4-技術選択の比較)
5. [アーキテクチャ設計](#5-アーキテクチャ設計)
6. [プラットフォーム別実装方式](#6-プラットフォーム別実装方式)
7. [データフロー](#7-データフロー)
8. [既存コードへの影響範囲](#8-既存コードへの影響範囲)
9. [ユーザー体験設計](#9-ユーザー体験設計)
10. [未解決の技術的課題](#10-未解決の技術的課題)
11. [実装ロードマップ](#11-実装ロードマップ)

---

## 1. 背景と目的

### 1.1 プロジェクトの動機

現在のKoeMoji-Goは、Windows環境でシステム音声とマイク音声を同時録音するために**外部ツール（VoiceMeeter）への依存**が必要です。この依存関係を削減し、KoeMoji-Go単体で以下を実現します：

```
【現在】
システム音声 ──┐
              ├→ VoiceMeeter → KoeMoji-Go録音
マイク音声 ────┘

【目標】
システム音声 ──┐
              ├→ KoeMoji-Go内でミックス → 録音
マイク音声 ────┘
```

### 1.2 期待される効果

- **ユーザビリティ向上**: 外部ツールの設定不要
- **トラブル削減**: VoiceMeeterの設定ミス・競合問題の解消
- **クロスプラットフォーム統一**: Windows/macOSで同じUI
- **保守性向上**: 依存関係のシンプル化

---

## 2. 現状分析

### 2.1 既存実装の状況

#### internal/recorder/recorder.go
- **単一デバイス録音**のみ対応
- PortAudioを使用
- VoiceMeeter統合は「デバイス自動検出」機能として実装

#### config.json
```json
{
  "recording_device_name": "",  // 単一デバイスのみ
  "audio_normalization_enabled": true
}
```

### 2.2 VoiceMeeter統合の現状（v1.6.0）

**実装内容**:
- `recorder.DetectVoiceMeeter()` でVoiceMeeter Outputを検出
- 設定画面に「VoiceMeeter設定を適用」ボタン（Windows専用）
- 音量自動正規化機能

**課題**:
- VoiceMeeterのインストールが前提
- VoiceMeeterの設定（システム音声のルーティング）をユーザーが手動で行う必要
- Windows専用機能

### 2.3 ユーザーからの要望

- 「VoiceMeeterの設定が難しい」
- 「外部ツール不要で録音したい」
- 「macOSでも同じ機能がほしい」

---

## 3. 要件定義

### 3.1 機能要件

#### 必須要件（Must Have）
- [ ] システム音声とマイク音声を同時録音
- [ ] 両方の音声を1つのWAVファイルに保存
- [ ] 音量バランス調整機能（システム:マイクの比率設定）
- [ ] リアルタイムでのオーディオミキシング

#### 重要要件（Should Have）
- [ ] クロスプラットフォーム対応（Windows/macOS）
- [ ] サンプルレート・ビット深度の自動調整
- [ ] 録音中の音量レベル表示
- [ ] エラーハンドリング（デバイス切断・サンプルレート不一致）

#### 望ましい要件（Nice to Have）
- [ ] 録音前のテスト機能
- [ ] リアルタイム波形表示
- [ ] デバイス毎の個別音量調整

### 3.2 非機能要件

- **パフォーマンス**: CPU使用率 10% 以下（通常録音時）
- **レイテンシ**: 100ms 以下
- **メモリ**: バッファサイズを最小限に（既存実装の2倍程度）
- **互換性**: 既存の単一デバイス録音機能を維持

### 3.3 制約事項

- **Windows**: Stereo Mix または仮想デバイス（必要な場合）
- **macOS**: 集約デバイス作成が必要な場合あり
- **PortAudio**: 既存のPortAudioライブラリを活用

---

## 4. 技術選択の比較

### 4.1 アプローチ1: デュアルストリーム + ソフトウェアミキサー（推奨）

#### 概要
2つの独立したPortAudioストリームを開き、リアルタイムでソフトウェアミキシング。

#### メリット
- ✅ クロスプラットフォーム対応
- ✅ 既存のPortAudioコードを活用
- ✅ シンプルなアーキテクチャ
- ✅ 音量バランス調整が容易

#### デメリット
- ❌ Windows: Stereo Mix有効化が必要な場合あり
- ❌ 同期処理が必要（サンプルレート不一致対応）

#### 技術スタック
- **PortAudio**: デバイス入力
- **Go標準ライブラリ**: ミキシング処理
- **Goroutine**: 並行処理

---

### 4.2 アプローチ2: Windows WASAPI Loopback直接実装

#### 概要
go-wcaライブラリを使用し、Windows WASAPIのLoopback機能でシステム音声を直接キャプチャ。

#### メリット
- ✅ Windows最適化
- ✅ Stereo Mix不要
- ✅ 高品質・低レイテンシ

#### デメリット
- ❌ Windows専用コード
- ❌ macOSは別実装が必要
- ❌ 新しいライブラリ依存（go-wca）
- ❌ 保守コストの増加

#### 技術スタック
- **go-wca**: WASAPI Loopback（Windows）
- **PortAudio**: マイク入力
- **独自実装**: プラットフォーム分岐

---

### 4.3 アプローチ3: 仮想デバイスの自動作成

#### 概要
Windows: VB-CABLE自動インストール
macOS: 集約デバイス自動作成

#### メリット
- ✅ ユーザー操作不要

#### デメリット
- ❌ 管理者権限が必要
- ❌ セキュリティリスク
- ❌ OS設定の変更（副作用）
- ❌ 実装コストが非常に高い

#### 結論
**採用しない**（リスクが高すぎる）

---

### 4.4 技術選択の決定

| 項目 | アプローチ1 | アプローチ2 | アプローチ3 |
|------|-------------|-------------|-------------|
| クロスプラットフォーム | ⭐⭐⭐ | ⭐ | ⭐⭐ |
| 実装コスト | ⭐⭐⭐ | ⭐⭐ | ⭐ |
| ユーザビリティ | ⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐ |
| 保守性 | ⭐⭐⭐ | ⭐⭐ | ⭐ |
| セキュリティ | ⭐⭐⭐ | ⭐⭐⭐ | ⭐ |

**決定**: **アプローチ1（デュアルストリーム + ソフトウェアミキサー）**

**理由**:
- クロスプラットフォーム対応が最優先
- 既存コードとの親和性が高い
- 保守性・拡張性に優れる

---

## 5. アーキテクチャ設計

### 5.1 システム構成図

```
┌─────────────────────────────────────────────────┐
│              KoeMoji-Go Application              │
├─────────────────────────────────────────────────┤
│                                                   │
│  ┌──────────────────────────────────────────┐   │
│  │         DualRecorder                      │   │
│  │  ┌───────────────┐  ┌──────────────┐     │   │
│  │  │ SystemCapture │  │ MicCapture   │     │   │
│  │  │ (PortAudio)   │  │ (PortAudio)  │     │   │
│  │  └───────┬───────┘  └──────┬───────┘     │   │
│  │          │                  │             │   │
│  │          └──────┬───────────┘             │   │
│  │                 ▼                         │   │
│  │         ┌──────────────┐                  │   │
│  │         │ AudioMixer   │                  │   │
│  │         │ - リサンプリング │                  │   │
│  │         │ - 音量調整     │                  │   │
│  │         │ - ミキシング   │                  │   │
│  │         └──────┬───────┘                  │   │
│  │                ▼                         │   │
│  │         ┌──────────────┐                  │   │
│  │         │ WAV Writer   │                  │   │
│  │         └──────────────┘                  │   │
│  └──────────────────────────────────────────┘   │
│                                                   │
└─────────────────────────────────────────────────┘
```

### 5.2 主要コンポーネント

#### DualRecorder
- 2つのPortAudioストリームを管理
- ミキサーとの統合
- 録音制御（開始/停止）

#### AudioMixer
- 2つの入力ストリームをリアルタイムでミックス
- サンプルレート変換
- 音量バランス調整

#### DeviceManager
- システム音声デバイスの検出
- マイクデバイスの検出
- デバイス互換性チェック

---

## 6. プラットフォーム別実装方式

### 6.1 Windows実装

#### システム音声キャプチャ
**方式A: Stereo Mix使用**（ユーザーが手動で有効化）
```go
// Stereo Mixデバイスを検出
device := findDeviceByName("Stereo Mix")
```

**方式B: WASAPI Loopback**（将来的な選択肢）
```go
// go-wcaを使用した直接キャプチャ
// Phase 2で検討
```

#### マイク入力
```go
// デフォルトマイク or ユーザー指定
micDevice := getDefaultInputDevice()
```

### 6.2 macOS実装

#### システム音声キャプチャ
**方式: 集約デバイス**
```go
// 既存の集約デバイスを使用
// または、ユーザーがAudio MIDI設定で作成
device := findDeviceByName("koemoji")  // 集約デバイス名
```

#### マイク入力
```go
// 集約デバイスに含まれる場合はそこから
// または別デバイスとして指定
```

---

## 7. データフロー

### 7.1 録音開始フロー

```
1. ユーザー操作: 録音ボタンクリック
   ↓
2. DualRecorder.Start()
   ↓
3. デバイス検証
   - システム音声デバイス存在確認
   - マイクデバイス存在確認
   - サンプルレート互換性チェック
   ↓
4. 2つのPortAudioストリーム初期化
   - SystemCapture.Start()
   - MicCapture.Start()
   ↓
5. AudioMixer起動
   - 2つのバッファをリアルタイム処理
   ↓
6. WAVファイル書き込み開始
```

### 7.2 リアルタイムミキシングフロー

```
┌─────────────────┐      ┌─────────────────┐
│ SystemCapture   │      │ MicCapture      │
│ Callback        │      │ Callback        │
│ (44.1kHz)       │      │ (48kHz)         │
└────────┬────────┘      └────────┬────────┘
         │                        │
         │ Buffer 1               │ Buffer 2
         ▼                        ▼
    ┌────────────────────────────────┐
    │      AudioMixer               │
    │  1. リサンプリング (統一)      │
    │  2. 音量調整                  │
    │     - System × 0.7           │
    │     - Mic × 1.0              │
    │  3. ミックス (加算合成)        │
    │  4. クリッピング防止          │
    └───────────┬────────────────────┘
                ▼
         ┌─────────────┐
         │ Mixed Buffer│
         └──────┬──────┘
                ▼
         ┌─────────────┐
         │ WAV Writer  │
         └─────────────┘
```

### 7.3 停止フロー

```
1. ユーザー操作: 停止ボタンクリック
   ↓
2. DualRecorder.Stop()
   ↓
3. 両ストリーム停止
   - SystemCapture.Stop()
   - MicCapture.Stop()
   ↓
4. 残バッファの処理
   ↓
5. WAVファイルクローズ
   ↓
6. 正規化処理（オプション）
```

---

## 8. 既存コードへの影響範囲

### 8.1 新規ファイル

```
internal/recorder/
├── dual_recorder.go      【新規】デュアル録音コア
├── mixer.go              【新規】オーディオミキサー
└── resampler.go          【新規】サンプルレート変換
```

### 8.2 変更が必要なファイル

#### internal/config/config.go
```go
type Config struct {
    // 既存
    RecordingDeviceName string `json:"recording_device_name"`

    // 追加
    DualRecordingEnabled    bool    `json:"dual_recording_enabled"`
    SystemAudioDeviceName   string  `json:"system_audio_device_name"`
    MicrophoneDeviceName    string  `json:"microphone_device_name"`
    SystemAudioVolume       float64 `json:"system_audio_volume"`       // 0.0-1.0
    MicrophoneVolume        float64 `json:"microphone_volume"`         // 0.0-1.0
}
```

#### internal/gui/app.go
```go
// 録音開始ロジックに分岐追加
if config.DualRecordingEnabled {
    recorder = NewDualRecorder(...)
} else {
    recorder = NewRecorder(...)  // 既存
}
```

#### internal/gui/dialogs.go
```go
// 設定ダイアログにデュアル録音設定追加
func showRecordingSettingsDialog() {
    // トグル: デュアル録音ON/OFF
    // デバイス選択: システム音声
    // デバイス選択: マイク
    // スライダー: 音量バランス
}
```

### 8.3 下位互換性

- 既存の単一デバイス録音機能は**そのまま維持**
- `dual_recording_enabled: false` がデフォルト
- 既存ユーザーに影響なし

---

## 9. ユーザー体験設計

### 9.1 UI設計案

#### 設定画面（拡張）

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
録音設定

録音モード:
  ⚪ シングルデバイス（従来）
  ⚫ デュアルデバイス（システム音声+マイク）

【デュアルデバイス設定】
┌─────────────────────────────────────┐
│ システム音声:                         │
│   [Stereo Mix              ▼]       │
│   音量: ━━━━●━━━━ 70%                │
│                                      │
│ マイク:                              │
│   [Realtek Microphone      ▼]       │
│   音量: ━━━━━━━━●━ 100%              │
│                                      │
│ [🔍 デバイスを自動検出]                │
│                                      │
│ ⚠️ システム音声にStereo Mixが          │
│    表示されない場合は、Windowsの        │
│    サウンド設定で有効化してください。    │
│    [セットアップガイドを見る]           │
└─────────────────────────────────────┘

音量自動調整: [✓] ON（推奨）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

#### 録音中の表示

```
┌──────────────────────────────┐
│ 🔴 録音中 (00:05:32)          │
│                               │
│ システム音声: ▰▰▰▰▰▰▱▱▱▱ 65% │
│ マイク:       ▰▰▰▰▰▰▰▰▱▱ 80% │
└──────────────────────────────┘
```

### 9.2 ユーザーフロー

#### 初回設定フロー
```
1. ユーザー: 設定画面を開く
   ↓
2. 録音モードで「デュアルデバイス」を選択
   ↓
3. 「デバイスを自動検出」ボタンをクリック
   ↓
4. システム:
   - Stereo Mix検出 → 自動設定
   - 見つからない → ガイド表示
   ↓
5. マイクを選択
   ↓
6. 音量バランス調整（デフォルト: System 70%, Mic 100%）
   ↓
7. 保存
```

#### エラー対応フロー
```
問題: Stereo Mixが見つからない
  ↓
解決策1: セットアップガイドへ誘導
  - Windowsサウンド設定の手順を表示
  ↓
解決策2: 代替方法の提案
  - VoiceMeeter使用（既存機能）
  - VB-CABLEインストール案内
```

---

## 10. 未解決の技術的課題

### 10.1 優先度：高

#### 課題1: サンプルレート不一致の処理
**問題**:
- システム音声: 48kHz
- マイク: 44.1kHz

**検討中の解決策**:
- A. PortAudioのリサンプリング機能を使用
- B. go標準ライブラリで線形補間実装
- C. 外部ライブラリ（libsamplerate）のGoバインディング

**決定事項**: 未定（実装フェーズで検証）

---

#### 課題2: バッファ同期
**問題**:
- 2つのストリームのコールバックタイミングが異なる
- バッファサイズが異なる可能性

**検討中の解決策**:
- A. リングバッファで吸収
- B. タイムスタンプベースの同期
- C. 固定サイズバッファでブロッキング

**決定事項**: 未定（プロトタイプで検証）

---

### 10.2 優先度：中

#### 課題3: レイテンシの最適化
**目標**: 100ms以下

**検討ポイント**:
- バッファサイズの調整
- コールバック処理の最適化
- Goroutineのスケジューリング

---

#### 課題4: Windows Stereo Mixの有効化方法
**問題**: 多くのユーザーがStereo Mixを無効化している

**検討中の解決策**:
- A. ユーザーに手動有効化を依頼（ガイド充実）
- B. プログラムから有効化（管理者権限必要、リスク高）
- C. 代替デバイス（VB-CABLE等）の自動インストール案内

**決定事項**: **A案（ガイド充実）**
理由: セキュリティ・保守性を優先

---

### 10.3 優先度：低

#### 課題5: macOS集約デバイスの自動作成
**現状**: ユーザーがAudio MIDI設定で手動作成

**将来的な改善案**:
- AppleScriptで自動作成スクリプト提供
- アプリ内からAudio MIDI設定を開くショートカット

---

## 11. 実装ロードマップ

### Phase 1: プロトタイプ検証（1-2週間）

**目標**: 技術的実現可能性の検証

- [ ] デュアルストリーム基本実装
- [ ] 簡易ミキサー実装
- [ ] Windows環境でのテスト
- [ ] サンプルレート不一致問題の解決策確定
- [ ] バッファ同期方式の決定

**成果物**:
- 動作するプロトタイプ
- 技術的課題の洗い出し完了

---

### Phase 2: コア機能実装（2-3週間）

**目標**: 基本機能の完成

- [ ] DualRecorderクラス実装
- [ ] AudioMixerクラス実装
- [ ] Resamplerクラス実装（必要な場合）
- [ ] 設定項目の追加（Config）
- [ ] 単体テスト作成

**成果物**:
- internal/recorder/パッケージ完成
- テストカバレッジ 70%以上

---

### Phase 3: UI統合（1-2週間）

**目標**: ユーザーが使える状態に

- [ ] 設定ダイアログの拡張
- [ ] デバイス選択UI実装
- [ ] 音量バランス調整UI実装
- [ ] 録音中の音量レベル表示
- [ ] エラーメッセージの整備

**成果物**:
- GUI完成
- ユーザーガイド更新

---

### Phase 4: テスト・検証（1週間）

**目標**: 品質保証

- [ ] Windows 10/11でのテスト
- [ ] macOS（Ventura, Sonoma）でのテスト
- [ ] 長時間録音テスト
- [ ] 各種デバイス組み合わせテスト
- [ ] パフォーマンス測定

**成果物**:
- テストレポート
- 既知の問題リスト

---

### Phase 5: ドキュメント整備（3-5日）

**目標**: ユーザーサポート

- [ ] セットアップガイド更新
- [ ] トラブルシューティング追加
- [ ] デュアル録音の使い方ページ作成
- [ ] CLAUDE.md更新

**成果物**:
- 完全なドキュメント

---

### Phase 6: リリース準備（3-5日）

**目標**: v1.8.0リリース

- [ ] VoiceMeeter統合との関係整理
- [ ] 移行ガイド作成
- [ ] リリースノート作成
- [ ] mainブランチへのマージ

---

## 📊 進捗管理

### 現在のステータス

| Phase | ステータス | 開始日 | 完了予定 |
|-------|-----------|--------|----------|
| Phase 1 | 🔍 計画中 | 未定 | 未定 |
| Phase 2 | ⏳ 未着手 | - | - |
| Phase 3 | ⏳ 未着手 | - | - |
| Phase 4 | ⏳ 未着手 | - | - |
| Phase 5 | ⏳ 未着手 | - | - |
| Phase 6 | ⏳ 未着手 | - | - |

---

## 🤝 意思決定記録

### 決定事項

| 日付 | 決定内容 | 理由 |
|------|----------|------|
| 2025-10-23 | アプローチ1（デュアルストリーム）を採用 | クロスプラットフォーム対応優先 |
| 2025-10-23 | Stereo Mix手動有効化方式 | セキュリティ・保守性優先 |
| 2025-10-23 | 既存機能を維持（後方互換性） | ユーザー影響を最小化 |

### 保留事項

| 項目 | 理由 | 決定時期 |
|------|------|----------|
| サンプルレート変換方式 | プロトタイプで検証必要 | Phase 1完了時 |
| バッファ同期方式 | 実装しながら最適化 | Phase 1-2 |
| macOS集約デバイス自動作成 | 優先度低、将来検討 | Phase 6以降 |

---

## 📝 メモ・議論ログ

### 2025-10-23: 初期設計ミーティング

**参加者**: ユーザー、Claude Code

**議論内容**:
- VoiceMeeter依存削減の必要性について合意
- クロスプラットフォーム対応を最優先とすることを確認
- デュアルストリーム方式を採用決定

**次のアクション**:
- [ ] 技術的課題の詰め（サンプルレート、同期）
- [ ] プロトタイプ実装の着手判断

---

## 📚 参考資料

### 関連ドキュメント
- [VoiceMeeterIntegration.md](./VoiceMeeterIntegration.md) - 既存のVoiceMeeter統合設計
- [NAudio WASAPI Loopback技術レポート](../../NAudio_WASAPI_Loopback_Report.md) - Windows技術参考

### 技術文献
- [PortAudio Documentation](http://www.portaudio.com/docs/v19-doxydocs/)
- [go-wca (Windows Core Audio)](https://github.com/moutend/go-wca)
- [Audio Resampling Techniques](https://ccrma.stanford.edu/~jos/resample/)

---

**最終更新**: 2025-10-23
**次回レビュー**: Phase 1完了時
