# VoiceMeeter統合設計書

## 📋 概要

Windows環境でシステム音声+マイク同時録音を簡単に実現するための設計。
VoiceMeeterとの統合により、ユーザーが最小限の操作で録音環境を構築できる。

## 🎯 設計方針

### ユーザー主導の明示的設定
- ❌ 自動検出・自動設定は行わない
- ✅ ユーザーが明示的にボタンを押して設定
- ✅ インストール順序に依存しない設計

**理由**:
- VoiceMeeterとKoeMoji-Goのインストール順序が不定
- 自動検出では後からVoiceMeeterを入れたユーザーをカバーできない
- ユーザーは既にVoiceMeeterを手動インストールしているため、設定ボタンを押すのも自然

## 🎨 UI設計

### 設定画面への追加要素

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
録音設定

録音デバイス: [デバイス名 ▼]

┌────────────────────────────────┐
│ 💡 システム音声+マイク同時録音          │
│                                        │
│ VoiceMeeterをインストール済みの方は、   │
│ 下のボタンで最適な設定を自動適用できます。│
│                                        │
│ [VoiceMeeter設定を適用]  [ガイドを見る] │
└────────────────────────────────┘

音量自動調整: [✓] ON（推奨）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### ボタンの動作

#### 「VoiceMeeter設定を適用」ボタン
1. VoiceMeeter Outputデバイスを検索
2. **見つかった場合**:
   - 録音デバイスを「VoiceMeeter Output」に設定
   - 音量自動調整をONに設定
   - 成功メッセージ: "✓ VoiceMeeter設定を適用しました"
3. **見つからない場合**:
   - エラー: "VoiceMeeter Outputが見つかりません"
   - 補足: "VoiceMeeterがインストール済みか確認してください"

#### 「ガイドを見る」ボタン
- `docs/user/RECORDING_SETUP.md` の該当セクションを開く

## ⚙️ 機能設計

### 新規設定項目

```json
{
  "recording_device_name": "",
  "audio_normalization_enabled": true
}
```

### VoiceMeeter検出ロジック

**検出対象デバイス名**（部分一致、大文字小文字無視）:
- "VoiceMeeter Output"
- "VoiceMeeter Input"
- "VoiceMeeter Aux"
- "CABLE Output"

**検出方法**:
1. `recorder.ListDevices()` で全デバイス取得
2. 上記キーワードで名前マッチング
3. 最初に見つかったデバイスを使用

### 音量自動正規化

#### 処理タイミング
録音停止時（メモリ上で処理）

```
録音停止 → 音量測定 → 正規化判定 → 必要なら増幅 → ファイル保存
```

#### アルゴリズム
**適応的ピークノーマライズ**

1. 最大振幅を検出
2. しきい値（例: 5000）未満の場合のみ処理
3. 目標レベル（例: 20000）まで安全に増幅
4. クリッピング防止（32767以下に制限）

**制御**:
- `audio_normalization_enabled` でON/OFF
- VoiceMeeter適用時は自動でON
- ユーザーは設定画面で変更可能

## 🔄 ユーザー体験フロー

### 理想的なシナリオ

```
1. ユーザー: VoiceMeeterをインストール
   ↓
2. ユーザー: KoeMoji-Goを起動
   ↓
3. ユーザー: 設定画面（cキー）を開く
   ↓
4. ユーザー: 「VoiceMeeter設定を適用」をクリック
   ↓
5. アプリ: VoiceMeeter Outputを検出・設定
   ↓
6. アプリ: 音量自動調整をON
   ↓
7. ✅ 完了！録音可能
```

### エラー時のフロー

```
1. ボタンクリック
   ↓
2. VoiceMeeter Output 見つからない
   ↓
3. エラーメッセージ表示
   ↓
4. [セットアップガイドを見る] ボタン
   ↓
5. RECORDING_SETUP.md を表示
```

## 🚀 実装範囲

### Phase 1: VoiceMeeter統合基盤
- [ ] 設定項目追加: `audio_normalization_enabled`
- [ ] VoiceMeeter検出関数
- [ ] 設定画面UI拡張（ボタン追加）
- [ ] 「VoiceMeeter設定を適用」機能
- [ ] 音量自動正規化エンジン
- [ ] ドキュメント更新

### Phase 2: macOS対応（将来）
- [ ] BlackHole/集約デバイス検出
- [ ] macOS用設定適用ボタン

### Phase 3: 高度な機能（将来）
- [ ] 録音前のテスト機能
- [ ] 音量レベルメーター表示
- [ ] 診断ツール

## ✅ 設計の利点

1. **インストール順序に依存しない**
   - いつVoiceMeeterを入れても対応可能

2. **ユーザー主導で予測可能**
   - 自動で勝手に設定が変わらない
   - 明示的なボタン操作で安心

3. **トラブル時も対処しやすい**
   - エラーメッセージが具体的
   - ガイドへの導線が明確

4. **拡張性が高い**
   - macOSにも同じパターン適用可能
   - 将来的な仮想デバイス追加も容易

## 🔧 プラットフォーム対応

### Windows
- VoiceMeeter自動検出
- 設定適用ボタン（今回実装）

### macOS
- 将来的に同様の機能追加可能
- BlackHole/集約デバイス検出
- 「BlackHole設定を適用」ボタン

---

**最終更新**: 2025-10-04
**ステータス**: 設計完了・実装待ち
